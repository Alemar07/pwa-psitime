<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b1430">
<title>MF Gestor de Citas</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="logo_sofa_cal_transparent_1024.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
:root{
  --bg-top:#1a1f3c;
  --bg-bottom:#07263a;
  --card:#0e1a2f;
  --card-2:#0b1630;
  --muted:#aab6c7;
  --text:#e8eef7;
  --white:#fff;
  --brand1:#15b7ff;
  --brand2:#5e5bff;
  --ok:#1abc9c;
  --danger:#ef5964;
  --chip:#23314f;
  --soft-shadow:0 10px 30px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  background: radial-gradient(1200px 800px at 40% -10%, #2a214b 0%, #0b2440 50%, #051a2d 100%) fixed;
}

/* ===== Generic ===== */
.container{max-width:980px;margin:0 auto;padding:18px}
.header{
  position:sticky; top:0; z-index:5; backdrop-filter:saturate(160%) blur(14px);
  background:linear-gradient(180deg, rgba(21,16,56,.85), rgba(7,28,49,.78));
  border-bottom:1px solid rgba(255,255,255,.06)
}
.appbar{display:flex;align-items:center;gap:12px;padding:14px 18px}
.appbar img{width:38px;height:38px;border-radius:8px}
.h1{font-size:28px;margin:0;font-weight:800}
.sub{font-size:14px;opacity:.8;margin-top:2px}

/* Cards / Sections */
.section{
  margin:16px auto;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.09);
  border-radius:22px;
  padding:18px;
  box-shadow:var(--soft-shadow);
}

/* Inputs */
.field{margin:10px 0; position:relative}
.label{display:block;margin:8px 4px 6px 6px;font-weight:700;opacity:.85}
.input, select, textarea{
  width:100%; border:0; outline:0; color:#0b2440; font-weight:600;
  background:#f5f7fb; padding:14px 48px; border-radius:18px; font-size:16px;
}
textarea{min-height:140px; resize:vertical}
.icon-left{
  position:absolute; left:16px; top:50%; transform:translateY(-50%);
  opacity:.6; width:22px;height:22px; pointer-events:none; color:#0b2440
}
.eye{position:absolute; right:14px; top:50%; transform:translateY(-50%); opacity:.65; width:24px;height:24px; cursor:pointer}

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  gap:10px; border:0; padding:14px 18px; border-radius:18px;
  color:#fff; cursor:pointer; font-weight:800; letter-spacing:.2px;
}
.btn-wide{width:100%}
.btn-grad{ background: linear-gradient(90deg, var(--brand1), var(--brand2)); box-shadow:0 16px 36px rgba(63,94,251,.25)}
.btn-soft{ background:#fff; color:#0b2440; }
.btn-danger{ background:var(--danger) }
.btn-chip{
  background:var(--chip); padding:8px 12px; border-radius:14px; font-weight:700; color:#dbe6ff
}

.actions-row{display:flex;flex-wrap:wrap;gap:10px}
.divider{height:1px;background:rgba(255,255,255,.08);margin:10px 0}

/* ===== Login ===== */
.login-wrap{
  min-height:calc(100svh - 70px); display:grid; place-items:start center;
  padding-top:24px; padding-bottom:40px;
}
.login-card{
  width:min(680px, 92vw);
  background:linear-gradient(180deg, rgba(12,23,47,.96), rgba(11,27,54,.88));
  border:1px solid rgba(255,255,255,.14);
  border-radius:26px; padding:20px 18px 20px; box-shadow:var(--soft-shadow)
}
.login-head{
  display:flex; align-items:center; gap:14px; margin:2px 6px 12px
}
.login-head .logo{width:62px;height:62px;border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
.login-title{font-size:30px;margin:0;font-weight:900}
.login-sub{opacity:.8;margin:0}

/* ===== Calendar ===== */
.month-header{
  display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px
}
.month-title{font-size:22px;font-weight:900}
.nav-btn{
  border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06);
  color:var(--text); border-radius:14px; padding:10px 12px; cursor:pointer;
}
.grid-weekdays{display:grid; grid-template-columns:repeat(7,1fr); gap:10px; margin:10px 0; font-weight:800; opacity:.9}
.grid-days{display:grid; grid-template-columns:repeat(7,1fr); gap:10px}
.day{
  background:#e9edf6; color:#0b2440; border-radius:18px;
  height:56px; display:flex; align-items:center; justify-content:center;
  font-weight:900; box-shadow:0 8px 18px rgba(0,0,0,.15)
}
.day.out{opacity:.35}
.day.today{outline:3px solid #8fb6ff}
.day.sel{outline:3px solid #6d79ff}

/* ===== Events list ===== */
.day-title{font-size:24px;font-weight:900;margin:16px 4px}
.event{ padding:10px 0 16px }
.event + .event{ border-top:1px dashed rgba(255,255,255,.12) }
.event h4{margin:8px 0 6px;font-size:18px}
.event .meta{opacity:.8; margin-bottom:10px}

/* ===== Modal ===== */
dialog{border:0;padding:0;background:transparent}
dialog::backdrop{background:rgba(0,0,0,.55); backdrop-filter:blur(3px)}
.modal-card{
  width:min(700px,92vw);
  background:linear-gradient(180deg,#ffffff, #f6f7fb);
  color:#0b2440; border-radius:22px; padding:18px; margin:auto; box-shadow:var(--soft-shadow)
}
.modal-title{font-size:22px;font-weight:900;margin:0 0 12px;padding-right:96px}
#evtClose{position:absolute;top:10px;right:10px;z-index:10}
#evtPicked{display:none}

/* Contact search inside modal */
#evtContactSearchArea{ position:relative }
#evtContactSearchArea .searchbox{ position:relative; border-radius:16px; background:#fff; box-shadow:var(--soft-shadow) }
#evtContactSearch{ width:100%; border:0; outline:0; padding:14px 48px; font-size:16px; border-radius:16px }
#evtContactSearchArea .icon-left{ left:14px; color:#0b2440 }
#evtContactSearchArea .caret{
  position:absolute; right:14px; top:50%; transform:translateY(-50%);
  width:18px; height:18px; opacity:.5; pointer-events:none
}
#evtContactResults{
  margin:8px 0 0; padding:0; list-style:none; max-height:220px; overflow:auto;
  border-radius:14px; background:rgba(255,255,255,.97); box-shadow:var(--soft-shadow)
}
#evtContactResults li{ display:flex; gap:10px; align-items:center; padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); cursor:pointer }
#evtContactResults li:last-child{ border-bottom:none }

.hidden{display:none !important}

/* Responsive tweaks */
@media (min-width:900px){
  .login-wrap{place-items:center}
}
</style>
</head>
<body>

<!-- ========== HEADER (App) ========== -->
<header class="header hidden" id="appHeader">
  <div class="appbar container">
    <img src="logo_sofa_cal_transparent_512.png" alt="logo">
    <div>
      <h1 class="h1" id="topTitle">Enviar cita</h1>
      <div class="sub">MF Gestor de Citas</div>
    </div>
  </div>
</header>

<!-- ========== LOGIN ========== -->
<main id="loginView" class="login-wrap">
  <section class="login-card" id="cardCreate" style="display:none">
    <div class="login-head">
      <div class="logo"><img src="logo_sofa_cal_transparent_512.png" alt="" style="width:100%;height:100%"></div>
      <div>
        <h2 class="login-title">Crear cuenta</h2>
        <p class="login-sub">Privado · sin servidores · 100% local</p>
      </div>
    </div>
    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
      <input id="newUser" class="input" placeholder="Usuario" autocomplete="username">
    </div>
    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M6 10V7a6 6 0 1 1 12 0v3h1a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-9a1 1 0 0 1 1-1h1Zm2 0h8V7a4 4 0 1 0-8 0v3Z" fill="currentColor"/></svg>
      <input id="newPass" class="input" placeholder="Contraseña" type="password" autocomplete="new-password">
      <svg class="eye" id="eyeNew" viewBox="0 0 24 24"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z" fill="currentColor"/></svg>
    </div>
    <button class="btn btn-grad btn-wide" id="btnCreate">Crear y acceder</button>
  </section>

  <section class="login-card" id="cardLogin" style="display:none">
    <div class="login-head">
      <div class="logo"><img src="logo_sofa_cal_transparent_512.png" alt="" style="width:100%;height:100%"></div>
      <div>
        <h2 class="login-title">Iniciar sesión</h2>
        <p class="login-sub">MF Gestor de Citas</p>
      </div>
    </div>
    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
      <input id="loginUser" class="input" placeholder="Usuario" autocomplete="username">
    </div>
    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M6 10V7a6 6 0 1 1 12 0v3h1a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-9a1 1 0 0 1 1-1h1Zm2 0h8V7a4 4 0 1 0-8 0v3Z" fill="currentColor"/></svg>
      <input id="loginPass" class="input" placeholder="Contraseña" type="password" autocomplete="current-password">
      <svg class="eye" id="eyeLogin" viewBox="0 0 24 24"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z" fill="currentColor"/></svg>
    </div>
    <div class="actions-row">
      <button class="btn btn-grad btn-wide" id="btnLogin">Entrar</button>
      <button class="btn btn-soft btn-wide" id="btnWipe">Borrar datos de la app</button>
    </div>
  </section>
</main>

<!-- ========== APP VIEW ========== -->
<div id="appView" class="hidden">

  <section class="container section">
    <div class="month-header">
      <div class="month-title" id="monthTitle">Agenda</div>
      <div>
        <button class="nav-btn" id="prevMonth">◀</button>
        <button class="nav-btn" id="todayBtn">Hoy</button>
        <button class="nav-btn" id="nextMonth">▶</button>
      </div>
    </div>

    <div class="grid-weekdays">
      <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
    </div>
    <div class="grid-days" id="daysGrid"></div>
  </section>

  <section class="container section" id="dayPanel">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div class="day-title" id="dayTitle">Hoy</div>
      <button class="btn btn-chip" id="btnNewEvent">Nueva cita</button>
    </div>
    <div id="eventsList"></div>
  </section>

  <section class="container section">
    <h3 style="margin:8px 4px 12px">Enviar cita</h3>
    <div class="field">
      <label class="label">Fecha y hora del recordatorio</label>
      <input id="reminderDT" class="input" type="datetime-local">
    </div>

    <!-- Buscador de contactos “rápido” principal -->
    <div class="field" id="mainSearchArea">
      <label class="label">Contacto — Listado</label>
      <div class="searchbox" style="position:relative">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M16.5 16.5L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/></svg>
        <input id="contactSearch" class="input" type="search" placeholder="Buscar por nombre o teléfono" inputmode="search" autocomplete="off" style="padding-left:48px">
      </div>
      <ul id="contactResults" class="hidden" style="margin:8px 0 0; padding:0; list-style:none; border-radius:14px; overflow:hidden; background:rgba(255,255,255,.98); box-shadow:var(--soft-shadow)"></ul>
      <input type="hidden" id="selectedPhone">
      <input type="hidden" id="selectedName">
    </div>

    <div class="field">
      <label class="label">Mensaje</label>
      <textarea id="messageBox" class="input" placeholder="Texto del recordatorio…"></textarea>
    </div>

    <div class="actions-row">
      <button class="btn btn-grad" id="sendWA">Enviar cita</button>
    </div>

    <div class="divider"></div>

    <h3 style="margin:14px 4px 10px">Gestionar contactos</h3>
    <div class="field"><input id="contactName" class="input" placeholder="Nombre"></div>
    <div class="field">
      <input id="contactPhone" class="input" type="tel" inputmode="tel" placeholder="+34600111222" pattern="\\+?[0-9 ]*" />
    </div>
    <div class="actions-row">
      <button class="btn btn-soft" id="addContact">Añadir contacto</button>
      <button class="btn btn-danger" id="delContact">Eliminar contacto</button>
    </div>

    <div class="divider"></div>

    <h3 style="margin:14px 4px 10px">Copias de seguridad</h3>
    <div class="actions-row">
      <button class="btn btn-soft" id="exportCSV">Exportar CSV</button>
      <button class="btn btn-soft" id="exportEncrypted">Exportar copia cifrada</button>
      <button class="btn btn-soft" id="importBtn">Importar copia…</button>
      <input type="file" id="importFile" accept=".json,.csv" class="hidden">
    </div>
    <label style="display:flex;align-items:center;gap:10px;margin-top:12px">
      <input type="checkbox" id="autoDL">
      <span>Auto-descargar copia tras cada cambio de contactos</span>
    </label>

    <div style="display:flex;justify-content:center;margin-top:18px">
      <a href="#" id="logout" style="color:#ff9a9a;font-weight:800;text-decoration:underline">Cerrar sesión</a>
    </div>
  </section>
</div>

<!-- ========== MODAL NUEVA CITA ========== -->
<dialog id="eventModal">
  <form method="dialog" class="modal-card" id="evtForm">
    <h3 class="modal-title">Nueva cita</h3>
    <button class="btn btn-soft" id="evtClose">Cerrar</button>

    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M4 6h16v2H4zM4 10h16v2H4zM4 14h10v2H4z" fill="currentColor"/></svg>
      <input id="evtTitle" class="input" placeholder="Título de la cita">
    </div>

    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M7 2h10v2h2a1 1 0 0 1 1 1v4H4V5a1 1 0 0 1 1-1h2V2Zm-3 8h16v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V10Zm8 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z" fill="currentColor"/></svg>
      <input id="evtDateTime" type="datetime-local" class="input">
    </div>

    <!-- (opcional) fecha fin, conservamos hueco por si lo usas -->
    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M7 2h10v2h2a1 1 0 0 1 1 1v4H4V5a1 1 0 0 1 1-1h2V2Zm-3 8h16v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V10Z" fill="currentColor"/></svg>
      <input id="evtDateTimeEnd" type="datetime-local" class="input" placeholder="">
    </div>

    <!-- Buscador de contacto (reemplaza al select) -->
    <div class="field" id="evtContactSearchArea">
      <label class="label">Contacto</label>
      <div class="searchbox">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M16.5 16.5L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/>
        </svg>
        <input id="evtContactSearch" type="search" placeholder="Buscar por nombre o teléfono" inputmode="search" autocomplete="off">
        <svg class="caret" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <ul id="evtContactResults"></ul>
      <div id="evtPicked" class="btn-chip">
        <span id="evtPickedName"></span>
        <button type="button" class="remove" id="evtPickedClear">Quitar</button>
      </div>
      <input type="hidden" id="evtContactPhone">
      <input type="hidden" id="evtContactName">
    </div>

    <div class="field">
      <svg class="icon-left" viewBox="0 0 24 24"><path d="M6 19h12v2H6zM6 3h12v12H6z" fill="currentColor"/></svg>
      <textarea id="evtNotes" class="input" placeholder="Notas"></textarea>
    </div>

    <div class="actions-row" style="margin-top:8px">
      <button class="btn btn-grad btn-wide" id="evtSave">Guardar</button>
      <button class="btn btn-soft btn-wide" id="evtSend">Enviar cita</button>
    </div>
  </form>
</dialog>

<script>
/* ===========================
   Storage + Crypto helpers
=========================== */
const LS_USER = 'mf_user';
const LS_BOOK = 'mf_contacts_cipher';
const LS_SETTINGS = 'mf_settings';
const LS_EVENTS = 'mf_events';
const FIXED_BACKUP_PASS = 'MFGestorCitas';

const enc = new TextEncoder(); const dec = new TextDecoder();

// PBKDF2 -> AES-GCM
async function deriveKey(password, salt){
  const base = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:200000, hash:'SHA-256'},
    base,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
}
async function aesEncrypt(key, data){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(JSON.stringify(data)));
  return { iv: btoa(String.fromCharCode(...iv)), payload: btoa(String.fromCharCode(...new Uint8Array(cipher))) };
}
async function aesDecrypt(key, bundle){
  const iv = Uint8Array.from(atob(bundle.iv), c => c.charCodeAt(0));
  const bytes = Uint8Array.from(atob(bundle.payload), c => c.charCodeAt(0));
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, bytes);
  return JSON.parse(dec.decode(plain));
}

function getSettings(){
  return JSON.parse(localStorage.getItem(LS_SETTINGS) || '{"autoDL":false}');
}
function setSettings(s){ localStorage.setItem(LS_SETTINGS, JSON.stringify(s)); }

function nowISO(d=new Date()){ return d.toISOString(); }
function fmtDateKey(d){ return d.toISOString().slice(0,10); }
function pad(n){ return String(n).padStart(2,'0'); }
function fmtHuman(dt){
  const d = new Date(dt);
  return d.toLocaleString('es-ES', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
}
function fmtTime(dt){
  const d = new Date(dt);
  return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ===========================
   App state
=========================== */
let state = {
  user: null,          // { username, saltB64 }
  key: null,           // CryptoKey AES-GCM
  contacts: [],        // [{name, phone}]
  events: {},          // { 'YYYY-MM-DD': [ { id, title, start, end?, notes, contactName, contactPhone } ] }
  selDate: new Date(), // selected day
};

/* ===========================
   UI Helpers
=========================== */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
function show(id){ $(id).classList.remove('hidden'); }
function hide(id){ $(id).classList.add('hidden'); }
function toast(msg){ alert(msg); }

function updateHeader(title='Enviar cita'){ $('#topTitle').textContent = title; }

function openWhatsApp(phone, text){
  const num = (phone||'').replace(/\s+/g,'');
  if(!num){ toast('Selecciona un contacto válido'); return; }
  const url = `https://wa.me/${encodeURIComponent(num)}?text=${encodeURIComponent(text||'')}`;
  window.open(url, '_blank'); // evita “pantalla en blanco” al volver
}

/* ===========================
   LOGIN / CREATE
=========================== */
function hasUser(){ return !!localStorage.getItem(LS_USER); }

async function createUser(){
  const username = $('#newUser').value.trim();
  const password = $('#newPass').value;
  if(!username || !password){ toast('Introduce usuario y contraseña'); return; }
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(password, salt);
  const user = { username, saltB64: btoa(String.fromCharCode(...salt)) };
  localStorage.setItem(LS_USER, JSON.stringify(user));
  state.user = user; state.key = key; state.contacts = []; state.events = {};
  await saveContacts(); await saveEvents();
  enterApp();
}

async function login(){
  const user = JSON.parse(localStorage.getItem(LS_USER)||'null');
  const u = $('#loginUser').value.trim();
  const p = $('#loginPass').value;
  if(!user){ toast('No hay usuario creado aún'); return; }
  if(u !== user.username){ toast('Usuario incorrecto'); return; }
  const salt = Uint8Array.from(atob(user.saltB64), c=>c.charCodeAt(0));
  const key = await deriveKey(p, salt);
  state.user = user; state.key = key;
  await loadContacts(); await loadEvents();
  enterApp();
}

function logout(){
  // Limpia solo sesión en memoria.
  state = { user:null, key:null, contacts:[], events:{}, selDate:new Date() };
  hide('#appView'); hide('#appHeader'); show('#loginView');
  decideLoginCards();
}

function wipeApp(){
  if(confirm('Esto borrará usuario, contactos y eventos guardados en este navegador. ¿Continuar?')){
    localStorage.removeItem(LS_USER);
    localStorage.removeItem(LS_BOOK);
    localStorage.removeItem(LS_EVENTS);
    // ajusta UI
    $('#newUser').value=''; $('#newPass').value='';
    $('#loginUser').value=''; $('#loginPass').value='';
    decideLoginCards();
  }
}

function decideLoginCards(){
  $('#loginView').style.display='grid';
  if(hasUser()){ $('#cardLogin').style.display='block'; $('#cardCreate').style.display='none'; }
  else { $('#cardCreate').style.display='block'; $('#cardLogin').style.display='none'; }
}

/* ===========================
   CONTACTS (encrypted)
=========================== */
async function saveContacts(){
  if(!state.key) return;
  const bundle = await aesEncrypt(state.key, state.contacts);
  localStorage.setItem(LS_BOOK, JSON.stringify(bundle));
  if(getSettings().autoDL) exportEncrypted(true); // auto
}
async function loadContacts(){
  state.contacts = [];
  const raw = localStorage.getItem(LS_BOOK);
  if(!raw) return;
  const bundle = JSON.parse(raw);
  try{
    // normalmente cifrado con clave del usuario
    state.contacts = await aesDecrypt(state.key, bundle);
  }catch(e){
    // si fue copia con contraseña fija para import, inténtalo:
    const salt = enc.encode('fixed-salt'); // constante para backup
    const k = await deriveKey(FIXED_BACKUP_PASS, salt);
    try { state.contacts = await aesDecrypt(k, bundle); }
    catch(e2){ state.contacts = []; }
  }
}

/* ===========================
   EVENTS (plain local)
=========================== */
function saveEvents(){ localStorage.setItem(LS_EVENTS, JSON.stringify(state.events)); }
function loadEvents(){ state.events = JSON.parse(localStorage.getItem(LS_EVENTS) || '{}'); }

/* ===========================
   APP ENTER
=========================== */
function enterApp(){
  hide('#loginView'); show('#appHeader'); show('#appView');
  updateHeader('Enviar cita');
  // init UI defaults
  $('#reminderDT').value = new Date(Date.now()+3600e3).toISOString().slice(0,16);
  renderMonth(state.selDate);
  renderDay(state.selDate);
  renderContactSearch('#contactSearch','#contactResults','#selectedName','#selectedPhone');
  $('#messageBox').value = buildMessage(new Date($('#reminderDT').value));
}

/* ===========================
   Month render
=========================== */
function monthName(date){
  return date.toLocaleString('es-ES',{month:'long', year:'numeric'});
}
function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }
function renderMonth(refDate){
  $('#monthTitle').textContent = `Agenda · ${monthName(refDate)}`;
  const grid = $('#daysGrid'); grid.innerHTML='';
  const start = startOfMonth(refDate);
  const end = endOfMonth(refDate);
  // Monday-first grid
  const startIdx = (start.getDay()+6)%7;
  const total = startIdx + end.getDate();
  const cells = Math.ceil(total/7)*7;
  const todayKey = fmtDateKey(new Date());

  for(let i=0;i<cells;i++){
    const dayNum = i - startIdx + 1;
    const cell = document.createElement('button');
    cell.className = 'day';
    let d;
    if(dayNum<=0){
      d = new Date(refDate.getFullYear(), refDate.getMonth(), dayNum);
      cell.textContent = d.getDate(); cell.classList.add('out');
    }else if(dayNum> end.getDate()){
      d = new Date(refDate.getFullYear(), refDate.getMonth(), dayNum);
      cell.textContent = d.getDate(); cell.classList.add('out');
    }else{
      d = new Date(refDate.getFullYear(), refDate.getMonth(), dayNum);
      cell.textContent = dayNum;
    }
    const key = fmtDateKey(d);
    if(key===todayKey) cell.classList.add('today');
    if(fmtDateKey(state.selDate)===key) cell.classList.add('sel');

    cell.addEventListener('click',()=>{
      state.selDate = d;
      renderMonth(state.selDate);
      renderDay(state.selDate, true);
      // foco al panel
      $('#dayPanel').scrollIntoView({behavior:'smooth', block:'start'});
    });
    grid.appendChild(cell);
  }
}
$('#prevMonth').onclick = ()=>{ state.selDate = new Date(state.selDate.getFullYear(), state.selDate.getMonth()-1, 1); renderMonth(state.selDate); };
$('#nextMonth').onclick = ()=>{ state.selDate = new Date(state.selDate.getFullYear(), state.selDate.getMonth()+1, 1); renderMonth(state.selDate); };
$('#todayBtn').onclick = ()=>{ state.selDate = new Date(); renderMonth(state.selDate); renderDay(state.selDate,true); };

/* ===========================
   Day render + events
=========================== */
function getDayEvents(date){
  const k = fmtDateKey(date);
  return (state.events[k]||[]).slice().sort((a,b)=> new Date(a.start)-new Date(b.start));
}

function renderDay(date, fromCalendar=false){
  const title = date.toLocaleDateString('es-ES', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
  $('#dayTitle').textContent = title;
  const cont = $('#eventsList'); cont.innerHTML='';
  const list = getDayEvents(date);

  const btnRow = document.createElement('div');
  btnRow.style.margin='6px 0 14px';
  cont.appendChild(btnRow);

  if(list.length===0){
    const p = document.createElement('div'); p.style.opacity='.7'; p.textContent = 'No hay citas';
    cont.appendChild(p);
  }

  list.forEach(ev=>{
    const wrap = document.createElement('div'); wrap.className='event';
    const h = document.createElement('h4'); h.textContent = ev.title || '(Sin título)';
    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = `${fmtTime(ev.start)} · ${ev.contactName||''}`;

    const row = document.createElement('div'); row.className='actions-row';
    const bEdit = btn('Editar','btn btn-soft');
    const bSend = btn('Enviar cita','btn btn-soft');
    const bDel  = btn('Eliminar','btn btn-danger');

    bEdit.onclick = ()=> openEventModal('edit', ev);
    bSend.onclick = ()=>{
      const msg = buildMessage(new Date(ev.start), ev.title, ev.notes);
      openWhatsApp(ev.contactPhone, msg);
    };
    bDel.onclick = ()=>{
      if(confirm('¿Eliminar esta cita?')){
        const key = fmtDateKey(new Date(ev.start));
        state.events[key] = (state.events[key]||[]).filter(x=>x.id!==ev.id);
        saveEvents(); renderDay(state.selDate);
      }
    };

    row.append(bEdit,bSend,bDel);
    wrap.append(h,meta,row);
    cont.appendChild(wrap);
  });
}
function btn(text, cls){ const b=document.createElement('button'); b.className=cls; b.textContent=text; return b; }

/* ===========================
   Event Modal (New/Edit)
=========================== */
const dlg = $('#eventModal');
$('#btnNewEvent').onclick = ()=> openEventModal('new');
$('#evtClose').onclick = (e)=>{ e.preventDefault(); dlg.close(); };

function openEventModal(mode, ev=null){
  dlg.showModal();
  // header
  $('.modal-title').textContent = mode==='edit' ? 'Editar cita' : 'Nueva cita';

  const d = ev ? new Date(ev.start) : new Date(state.selDate);
  $('#evtTitle').value = ev?.title || '';
  $('#evtDateTime').value = new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), d.getMinutes()).toISOString().slice(0,16);
  $('#evtDateTimeEnd').value = ev?.end ? new Date(ev.end).toISOString().slice(0,16) : '';
  $('#evtNotes').value = ev?.notes || '';

  initEvtContactSearch();
  if(ev){
    // Preselecciona contacto
    pickEvtContact({name: ev.contactName||'', phone: ev.contactPhone||''});
  }

  $('#evtSave').onclick = (e)=>{ e.preventDefault(); saveEventFromModal(mode, ev); };
  $('#evtSend').onclick = (e)=>{ e.preventDefault(); sendEventFromModal(); };
}

function saveEventFromModal(mode, ev0){
  const title = $('#evtTitle').value.trim() || '(Sin título)';
  const start = new Date($('#evtDateTime').value);
  const end = $('#evtDateTimeEnd').value ? new Date($('#evtDateTimeEnd').value) : null;
  const notes = $('#evtNotes').value.trim();
  const { phone:contactPhone, name:contactName } = getEvtContact();

  if(!contactPhone){ toast('Selecciona un contacto'); return; }

  const key = fmtDateKey(start);
  state.events[key] = state.events[key]||[];

  if(mode==='edit'){
    const idx = state.events[key].findIndex(x=>x.id===ev0.id);
    const ev = { ...ev0, title, start: start.toISOString(), end: end?.toISOString()||null, notes, contactPhone, contactName };
    if(idx>-1) state.events[key][idx] = ev;
  }else{
    const ev = { id:crypto.randomUUID(), title, start:start.toISOString(), end:end?.toISOString()||null, notes, contactPhone, contactName };
    state.events[key].push(ev);
  }

  saveEvents();
  dlg.close();
  state.selDate = start; renderMonth(state.selDate); renderDay(state.selDate);
}

function sendEventFromModal(){
  const title = $('#evtTitle').value.trim() || '(Sin título)';
  const start = new Date($('#evtDateTime').value);
  const notes = $('#evtNotes').value.trim();
  const { phone:contactPhone } = getEvtContact();
  if(!contactPhone){ toast('Selecciona un contacto'); return; }
  const msg = buildMessage(start, title, notes);
  openWhatsApp(contactPhone, msg);
}

/* ==== Contact search in modal ==== */
const evtSearch   = () => $('#evtContactSearch');
const evtResults  = () => $('#evtContactResults');
const evtPicked   = () => $('#evtPicked');
const evtPickedNm = () => $('#evtPickedName');
const evtPhone    = () => $('#evtContactPhone');
const evtName     = () => $('#evtContactName');
const evtClearBtn = () => $('#evtPickedClear');

function getAllContacts(){ return state.contacts||[]; }

function renderEvtSuggestions(q){
  const ul = evtResults(); ul.innerHTML='';
  if(!q || !q.trim()) return;
  const term = q.trim().toLowerCase();
  const items = getAllContacts().filter(c =>
    (c.name||'').toLowerCase().includes(term) ||
    (c.phone||'').replace(/\s+/g,'').includes(term.replace(/\s+/g,'')))
    .slice(0,12);

  items.forEach(c=>{
    const li=document.createElement('li');
    li.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="opacity:.7">
        <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/>
      </svg>
      <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
        <div style="font-weight:700">${c.name||'Sin nombre'}</div>
        <div style="opacity:.65">${c.phone||''}</div>
      </div>
    `;
    li.onclick = ()=> pickEvtContact(c);
    ul.appendChild(li);
  });
}
function pickEvtContact(c){
  evtPhone().value = c.phone||''; evtName().value = c.name||'';
  evtPickedNm().textContent = c.name||'Sin nombre';
  evtPicked().style.display='flex'; evtResults().innerHTML=''; evtSearch().value='';
}
function clearEvtContact(){
  evtPhone().value=''; evtName().value=''; evtPicked().style.display='none';
}
function initEvtContactSearch(){
  clearEvtContact(); evtResults().innerHTML=''; evtSearch().value='';
  evtSearch().oninput = (e)=> renderEvtSuggestions(e.target.value);
  evtClearBtn().onclick = clearEvtContact;
}
function getEvtContact(){ return { phone: evtPhone().value||'', name: evtName().value||'' }; }

/* ===========================
   Main contact search
=========================== */
function renderContactSearch(inputSel, listSel, nameSel, phoneSel){
  const inp = $(inputSel), ul=$(listSel);
  function draw(q){
    ul.innerHTML='';
    const t=q.trim().toLowerCase();
    if(!t){ ul.classList.add('hidden'); return; }
    const results = (state.contacts||[]).filter(c=>
      (c.name||'').toLowerCase().includes(t) || (c.phone||'').replace(/\s+/g,'').includes(t.replace(/\s+/g,''))).slice(0,20);
    results.forEach(c=>{
      const li=document.createElement('li');
      li.style.cssText='display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.06);cursor:pointer;color:#0b2440';
      li.innerHTML = `<strong style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.name||'Sin nombre'}</strong>
                      <span style="opacity:.7">${c.phone||''}</span>`;
      li.onclick=()=>{
        $(nameSel).value = c.name||''; $(phoneSel).value = c.phone||'';
        inp.value = c.name ? `${c.name} (${c.phone||''})` : (c.phone||'');
        ul.classList.add('hidden');
      };
      ul.appendChild(li);
    });
    ul.classList.toggle('hidden', results.length===0);
  }
  inp.oninput = e=> draw(e.target.value);
  document.addEventListener('click', (ev)=>{ if(!ul.contains(ev.target) && ev.target!==inp) ul.classList.add('hidden'); });
}

/* ===========================
   Build default WA message
=========================== */
function buildMessage(dateObj, title='Recordatorio', notes=''){
  const d = dateObj;
  const fecha = d.toLocaleDateString('es-ES', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
  const hora = d.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
  return `¡Hola! 👋 Tienes una cita: *${title}* para el ${fecha} a las ${hora}.${notes?`\n\nNotas: ${notes}`:''}`;
}

/* ===========================
   Buttons / flows
=========================== */
$('#btnCreate').onclick = createUser;
$('#btnLogin').onclick = login;
$('#btnWipe').onclick = wipeApp;

$('#logout').onclick = (e)=>{ e.preventDefault(); logout(); };

$('#eyeLogin').onclick = ()=> togglePw('#loginPass','#eyeLogin');
$('#eyeNew').onclick   = ()=> togglePw('#newPass','#eyeNew');
function togglePw(inpSel, eyeSel){
  const i=$(inpSel); i.type = (i.type==='password'?'text':'password');
  // Opcional: podríamos alternar icono si lo deseas
}

/* Phone helper */
const phoneInput = $('#contactPhone');
phoneInput.addEventListener('focus', ()=>{
  if(!phoneInput.value.trim()) phoneInput.value='+34';
});

/* Add/Delete contact */
$('#addContact').onclick = async()=>{
  const name = $('#contactName').value.trim();
  let phone = $('#contactPhone').value.trim();
  if(!phone){ toast('Introduce un teléfono'); return; }
  if(!phone.startsWith('+')) phone = '+34'+phone.replace(/\D+/g,'');
  // dedup por teléfono
  const i = state.contacts.findIndex(c=> (c.phone||'')===phone);
  if(i>-1) state.contacts[i].name = name; else state.contacts.push({name, phone});
  await saveContacts();
  $('#contactName').value=''; $('#contactPhone').value='';
};
$('#delContact').onclick = async()=>{
  const name = $('#contactName').value.trim();
  let phone = $('#contactPhone').value.trim();
  if(phone && !phone.startsWith('+')) phone = '+34'+phone.replace(/\D+/g,'');
  state.contacts = state.contacts.filter(c => (name?c.name!==name:true) && (phone?c.phone!==phone:true));
  await saveContacts();
  $('#contactName').value=''; $('#contactPhone').value='';
};

/* Send WA from main */
$('#sendWA').onclick = ()=>{
  const dt = $('#reminderDT').value;
  const { value:phone } = $('#selectedPhone');
  const name = $('#selectedName').value;
  const msg = $('#messageBox').value || buildMessage(new Date(dt));
  if(!phone){ toast('Selecciona un contacto'); return; }
  openWhatsApp(phone, msg);
};

/* Default message update when dt changes */
$('#reminderDT').addEventListener('change', ()=>{
  $('#messageBox').value = buildMessage(new Date($('#reminderDT').value));
});

/* ===== Export / Import ===== */
$('#exportCSV').onclick = ()=>{
  const rows = [['Nombre','Telefono'], ...state.contacts.map(c=>[c.name||'', c.phone||''])];
  const csv = rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  download('contactos.csv', 'text/csv', csv);
};

async function exportEncrypted(silent=false){
  // Copia cifrada con contraseña fija (portable)
  const salt = enc.encode('fixed-salt');  // constante
  const key = await deriveKey(FIXED_BACKUP_PASS, salt);
  const bundle = await aesEncrypt(key, state.contacts);
  download(`copia-cifrada.json`, 'application/json', JSON.stringify(bundle));
  if(!silent) toast('Copia cifrada descargada');
}
$('#exportEncrypted').onclick = ()=> exportEncrypted(false);

$('#importBtn').onclick = ()=> { const f=$('#importFile'); f.value=''; f.click(); };
$('#importFile').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;                    // si cancelan, no aparece nada
  const text = await file.text();
  try{
    if(file.name.endsWith('.csv')){
      // simple CSV: Nombre,Telefono
      const lines = text.split(/\r?\n/).slice(1);
      lines.forEach(line=>{
        const parts = line.split(',');
        if(parts.length>=2){
          const name = parts[0].replace(/^"|"$/g,'').replace(/""/g,'"').trim();
          const phone = parts[1].replace(/^"|"$/g,'').replace(/""/g,'"').trim();
          if(phone) state.contacts.push({name, phone});
        }
      });
    }else{
      // JSON (en claro o cifrado con pass fija)
      const obj = JSON.parse(text);
      if(obj.iv && obj.payload){
        const salt = enc.encode('fixed-salt');
        const key = await deriveKey(FIXED_BACKUP_PASS, salt);
        const data = await aesDecrypt(key, obj);
        if(Array.isArray(data)) state.contacts = data;
      }else if(Array.isArray(obj)){
        state.contacts = obj;
      }
    }
    await saveContacts();
    toast('Importación completada');
  }catch(err){
    console.error(err); toast('No se pudo importar el archivo');
  }
});

/* ===== Auto-Descarga setting ===== */
$('#autoDL').checked = getSettings().autoDL;
$('#autoDL').onchange = ()=> setSettings({autoDL: $('#autoDL').checked});

/* ===== Utils ===== */
function download(name, mime, content){
  const blob = new Blob([content], {type:mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()}, 0);
}

/* ===== Init ===== */
window.addEventListener('load', ()=>{
  decideLoginCards();
  $('#contactPhone').setAttribute('inputmode','tel');
});

/* (opcional) registrar SW si existe */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
}
</script>
</body>
</html>
