<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>MF Gestor de Citas</title>
  <meta name="theme-color" content="#0f1c36">
  <meta name="theme-color" content="#0f1c36" media="(prefers-color-scheme: dark)">
  <link rel="manifest" href="manifest.webmanifest?v=ui21">
  <link rel="icon" href="favicon.ico" sizes="16x16 32x32 48x48">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-944M4YL7C3"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-944M4YL7C3');
	</script>
  <style>
	/* ===== 01 Variables ===== */
	:root{
	  --violet:#5e5bff; --cyan:#10b5ff;
	  --ink:#0b1220; --muted:#94a3b8; --soft:#eef2ff;
	  --glassBorder: rgba(255,255,255,.22);
	  --glassBg: rgba(8,12,24,.45);
	  --shadow: 0 40px 120px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.16);
	  --ok:#22c55e; --danger:#ef4444; --warning:#f59e0b;
	  
	  --app-bg:
		radial-gradient(1000px 520px at 88% -10%, rgba(255,105,180,.45), transparent 60%),
		radial-gradient(1100px 600px at -10% 100%, rgba(16,181,255,.38), transparent 62%),
		linear-gradient(180deg, #13203d 0%, #0f1c36 58%, #0a162d 100%);
	}
	body{
	  margin:0; overflow-x:hidden;
	  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
	  color:#e5e7eb;
	  background: var(--app-bg) fixed;
	  min-height: 100vh;
	}
	/* ===== 02 Base/Reset ===== */
	*, *::before, *::after{ box-sizing: border-box; }
	html, body{ height:100%; }
	html{ -webkit-text-size-adjust:100%; background:var(--app-bg); min-height: 100%; }
	@supports (-webkit-touch-callout: none){
	  @media (display-mode: standalone){ html, body{ background: var(--app-bg) !important; } }
	}
	/* ===== 03 Fondo decorativo ===== */
	body::before{
	  content:""; position:fixed; inset:-20% -20%; z-index:-1; pointer-events:none;
	  background: radial-gradient(1000px 520px at 88% -10%, rgba(255,105,180,.45), transparent 60%), radial-gradient(1100px 600px at -10% 100%, rgba(16,181,255,.38), transparent 62%), linear-gradient(180deg, #13203d 0%, #0f1c36 58%, #0a162d 100%);
	  transform:translateZ(0);
	}
	/* ===== 04 Topbar/Auth ===== */
	.auth-head{ display:flex; align-items:center; gap:14px; padding:14px 18px; }
	.logo-box{ width:44px; height:44px; border-radius:12px; overflow:hidden; flex:0 0 auto; }
	.logo-box img{ width:100%; height:100%; object-fit:cover; background:#fff }
	.title{ margin:0; font-size:clamp(22px,2.2vw,28px); font-weight:900 }
	.subtitle{ margin:2px 0 0; font-size:clamp(12px,1.6vw,14px); color:#c7d2fe }
	.hr{ height:1px; background:rgba(255,255,255,.14); margin:0 }
	body.login-mode .auth-head, body.login-mode .hr, body.setup-mode .auth-head, body.setup-mode .hr{ display:none; }
	body.login-mode #bottomNav,
	body.setup-mode #bottomNav {
	  display: none !important;
	}
	body:not(.login-mode):not(.setup-mode) .auth-head{
	  position:sticky; top:0; z-index:20;
	  backdrop-filter: blur(12px) saturate(120%);
	  background: rgba(8,12,24,.30);
	  border-bottom: 1px solid var(--glassBorder);
	  padding-top: calc(14px + env(safe-area-inset-top));
	}
	body:not(.login-mode):not(.setup-mode) .hr{ margin: 0 0 12px; }
	body:not(.login-mode):not(.setup-mode) .app-wrap{ padding-top: 20px; }
	/* ===== 05 Campos y formularios ===== */
	.field{ position:relative; }
	.field input, .field select, .field textarea, .field [type="datetime-local"]{
	  width:100%; border:1px solid rgba(255,255,255,.25); border-radius:18px;
	  padding:16px 48px 16px 44px; background:#ffffff;
	  font-size:17px; color:var(--ink);
	  box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 14px 30px rgba(0,0,0,.16);
	  transition: border-color .2s ease, box-shadow .2s ease;
	}
	.field input:focus, .field select:focus, .field textarea:focus {
		outline: none; border-color: var(--cyan); box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 14px 30px rgba(0,0,0,.16), 0 0 0 3px rgba(16,181,255,.35);
	}
	.field.field-error input, .field.field-error select { border-color: var(--danger); }
	.field input[type="datetime-local"]{ -webkit-appearance:none; appearance:none; min-height:56px; padding-right:14px; }
	.field select{ min-height:56px; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right .7rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;}
	.field textarea{ min-height:140px; resize:vertical; }
	.icon-left, .icon-right{ position:absolute; top:50%; transform:translateY(-50%); width:22px; height:22px; color:#667085; transition: color .2s ease; pointer-events: none;}
	.field:focus-within .icon-left { color: var(--violet); }
	.icon-left{ left:14px }
	.icon-right{ right:14px; cursor:pointer; pointer-events: all; }
	/* ===== 06 Botones/Chips ===== */
	.btn, .btn-ghost, .btn-outline{ transition: transform .15s ease-out, box-shadow .2s ease, background .2s ease; }
	.btn:active, .btn-ghost:active, .btn-outline:active { transform: translateY(1px) scale(.99); }
	.btn{
	  display:inline-flex; align-items:center; justify-content:center; gap:10px;
	  border:none; cursor:pointer; border-radius:22px; font-weight:800; color:white;
	  padding:18px 18px; width:100%;
	  background: linear-gradient(90deg, var(--cyan), var(--violet));
	  box-shadow: 0 18px 34px rgba(16,181,255,.28), 0 18px 34px rgba(94,91,255,.28);
	  letter-spacing:.2px; text-align:center;
	}
	.btn[disabled]{ cursor: not-allowed; opacity: .7; background: var(--muted); box-shadow: none; }
	.btn-ghost{
	  appearance:none; background:#fff; border:1px dashed rgba(255,255,255,.35);
	  color:#0b1220; padding:14px 16px; border-radius:18px; font-weight:800; width:100%;
	  display:inline-flex; align-items:center; justify-content:center; text-align:center;
	  box-shadow:0 10px 26px rgba(0,0,0,.16);
	}
	.btn-outline{ border:1px solid rgba(255,255,255,.35); background:#fff; color:#1f2a44; }
	.btn-danger{ background:linear-gradient(90deg,#ff6b6b,#ef4444); color:#fff; border:none }
	.btn-small{ padding:10px 14px; border-radius:12px; font-weight:800 }
	.spinner {
		width: 20px; height: 20px; border-radius: 50%;
		border: 3px solid rgba(255,255,255,.3);
		border-top-color: #fff;
		animation: spin 1s linear infinite;
	}
	.btn[disabled] .spinner { border-top-color: #666; }
	@keyframes spin { to { transform: rotate(360deg); } }
	/* ===== 07 Login/Setup ===== */
	.login-hero{ min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px 20px 40px; }
	.login-card{
	  width:min(560px, 100%); border-radius:26px; padding:24px 20px 20px;
	  backdrop-filter: blur(18px) saturate(120%); background: var(--glassBg);
	  border: 1px solid var(--glassBorder); box-shadow: var(--shadow);
	  position:relative;
	}
	.login-logo-wrap{ display:grid; place-items:center; margin-top:-40px; }
	.login-logo-circle{
	  width:86px; height:86px; border-radius:50%; display:grid; place-items:center;
	  background: radial-gradient(120% 120% at 10% 10%, rgba(255,255,255,.85), transparent 60%), linear-gradient(135deg, rgba(255,106,162,.85), rgba(16,181,255,.85));
	  padding:4px; box-shadow:0 18px 36px rgba(0,0,0,.35);
	}
	.login-logo-circle img{ width:100%; height:100%; border-radius:50%; display:block; background:#fff; padding:10px }
	.login-title{ color:#fff; text-align:center; margin:12px 0 2px; font-size:clamp(22px, 2.6vw, 28px); letter-spacing:.3px; font-weight:900 }
	.login-sub{ color:rgba(255,255,255,.78); text-align:center; font-size:13px; margin:0 0 18px }
	.login-fields{ display:grid; gap:16px }
	.login-field input{ background:#fff; border:none !important; border-radius:18px; box-shadow: 0 12px 28px rgba(0,0,0,.18) }
	/* ===== 08 Layout general ===== */
	.glass{
	  backdrop-filter: blur(14px) saturate(120%); background: var(--glassBg); border:1px solid var(--glassBorder); border-radius:24px; box-shadow: var(--shadow); padding:20px;
	}
	.span-2{ grid-column: 1 / -1; }
	.section-title{ margin:0 0 12px; font-weight:900; color:#fff; font-size: clamp(18px, 1.8vw, 20px); }
	.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
	/* ===== 09 Contactos ===== */
	.contact-picker{ display:grid; gap:10px }
	.search-wrap{ position:relative }
	.section-subtitle{ margin: 6px 0 8px; font-weight: 800; color: #c7d2fe; font-size: 14px; }
	.gc-split{ align-items: start; }
	.gc-sep{ margin-top: 12px; border-top: 1px solid rgba(255,255,255,.12); opacity: .9; }
	.contact-card{ margin-top:10px; border-radius:14px; border:1px solid var(--glassBorder); background:#fff; box-shadow:0 10px 22px rgba(0,0,0,.14); padding:12px; transition: all .2s ease; }
	.contact-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
	.contact-name{ font-weight:800; color:#0b1220; }
	.contact-phone{ color:#475569; font-variant-numeric:tabular-nums; font-size:14px; }
	.contact-actions{ display:flex; gap:8px; flex-wrap:wrap; }
	#contactSearch, #evtSearch{
	  width:100%; border:1px solid rgba(255,255,255,.25); border-radius:18px;
	  padding:14px 44px 14px 44px; background:#fff; font-size:16px; color: var(--ink); caret-color: var(--ink);
	  box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 12px 26px rgba(0,0,0,.16);
	}
	::placeholder{ color:#94a3b8; opacity:.9; }
	.search-icon{ position:absolute; left:14px; top:50%; transform:translateY(-50%); width:20px; height:20px; opacity:.6; pointer-events: none; }
	.clear-icon{ position:absolute; right:14px; top:50%; transform:translateY(-50%); width:20px; height:20px; opacity:.6; cursor:pointer; display:none; pointer-events: all; }
	#contactResults, #evtResults{
	  border:1px solid rgba(255,255,255,.25); border-radius:16px; background:#fff;
	  box-shadow: 0 12px 28px rgba(0,0,0,.18);
	  max-height:260px; overflow:auto; padding:6px;
	  animation: fadeIn .2s ease-out;
	}
	.result-item{
	  display:flex; align-items:center; gap:8px; width:100%; padding:12px 10px; border-radius:12px; cursor:pointer; border:1px solid transparent; background:transparent; font-size:16px; text-align:left; transition: background .15s ease, border-color .15s ease;
	}
	.result-item:hover, .result-item[aria-selected="true"]{ background: var(--soft); border-color: rgba(94,91,255,.24); }
	.result-name{ color:#0b1220; font-weight:700 }
	.result-phone{ color:#475569; font-variant-numeric: tabular-nums }
	/* ===== 10 Calendario ===== */
	.cal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px }
	.cal-title{ font-weight:900; color:#fff; font-size:clamp(18px, 2vw, 22px) }
	.cal-nav{ display:flex; gap:8px }
	.chip{
	  border:1px solid rgba(255,255,255,.3); border-radius:12px; padding:8px 10px; background:#fff; color:#0b1220; font-weight:700; cursor:pointer;
	  transition: transform .15s ease-out, box-shadow .2s ease, background .2s ease, color .2s ease;
	}
	.chip:active { transform: translateY(1px) scale(.99); }
	.cal-grid{ display:grid; grid-template-columns:repeat(7, minmax(0,1fr)); gap:6px; align-items:stretch }
	.cal-dow{ text-align:center; font-weight:800; color:#c7d2fe; padding:4px 0 6px; font-size:clamp(11px, 2.6vw, 13px) }
	.cal-cell{
	  position:relative; background:rgba(255,255,255,.94); color:#0b1220;
	  border-radius:14px; aspect-ratio:1/1; padding:6px 6px 12px; min-height:0;
	  box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 10px 22px rgba(0,0,0,.14);
	  display:block; cursor:pointer; touch-action:manipulation;
	  transition: transform .1s ease-out, background .2s ease;
	}
	.cal-cell:active{ transform:translateY(1px) scale(.995) }
	.cal-num{ position:absolute; top:6px; left:8px; font-weight:900; opacity:.9; font-size:clamp(12px, 3.1vw, 15px); letter-spacing:.1px }
	.cal-cell.cal-other{ background: rgba(255,255,255,.60); color: #64748b; }
	.cal-cell.cal-other .cal-num{ opacity: .55; }
	.cal-today{ outline:2px solid var(--violet); outline-offset:2px; }
	.cal-cell.cal-selected{ outline:3px solid var(--cyan); outline-offset:2px }
	.dots{ position:absolute; left:6px; right:6px; bottom:6px; display:flex; justify-content:center; gap:4px; flex-wrap:nowrap }
	.dot{ width:6px; height:6px; border-radius:50%; background:var(--violet); opacity:.95 }
	.dot.green{ background:var(--ok) }
	.dot.yellow{ background:var(--warning) }
	.dot.red{ background:var(--danger) }
	/* ===== 11 Lista del día / Eventos ===== */
	.day-list{ display:grid; gap:14px; margin-top:6px; }
	.day-list > .muted{ display:block; margin-top:6px; animation: fadeIn .3s ease-out; }
	.evt-item{ position:relative; background:#fff; color:#0b1220; border-radius:14px; padding:12px 12px; box-shadow: 0 10px 22px rgba(0,0,0,.18); animation: fadeIn .3s ease-out .1s backwards; }
	.evt-actions{ display:flex; gap:12px; flex-wrap:wrap; }
	.evt-sep{ height:1px; background:rgba(255,255,255,.12); margin:4px 8px; border-radius:1px; }
	/* ===== 12 Modal & Toast & Confirmation ===== */
	.day-toolbar{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
	#dayTitle{ margin:0; }
	#eventModal .modal-head{ position: relative; display: flex; align-items: center; justify-content: center; padding: 12px 16px; margin-bottom: 10px; min-height: 56px; }
	#eventModal .modal-title{ margin: 0; font-weight: 900; text-align: center; font-size: clamp(18px, 2.2vw, 20px); padding: 0 80px; color: white; }
	#eventModal #evtClose{ position: absolute; top: 10px; right: 10px; z-index: 2; }
	dialog.modal{ border:none; padding:0; background:transparent; }
	dialog.modal::backdrop{ background: rgba(8,12,24,.25); backdrop-filter: blur(6px) saturate(120%); animation: fadeIn .2s ease; }
	.modal-card{
	  position:relative; width:min(640px, 92vw); border-radius:24px;
	  background: var(--glassBg); border:1px solid var(--glassBorder);
	  box-shadow: var(--shadow); padding:16px;
	}
	.modal-actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
	.btn:focus-visible, .chip:focus-visible, .result-item:focus-visible{ outline:2px solid var(--cyan); outline-offset:2px; }
	.toast-container {
		position: fixed; bottom: calc(20px + env(safe-area-inset-bottom, 0)); left: 50%;
		transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column;
		align-items: center; gap: 10px; pointer-events: none;
	}
	.toast {
		color: #fff; padding: 12px 18px; border-radius: 16px;
		backdrop-filter: blur(10px) saturate(120%);
		border: 1px solid rgba(255,255,255,.2);
		box-shadow: 0 12px 28px rgba(0,0,0,.3);
		font-weight: 700; font-size: 15px;
		animation: toast-in .3s ease-out;
		pointer-events: all;
	}
	.toast.success { background: rgba(34, 197, 94, .5); }
	.toast.error { background: rgba(239, 68, 68, .5); }
	.toast.info { background: rgba(16, 181, 255, .5); }
	@keyframes toast-in { from { opacity: 0; transform: translateY(20px) scale(.95); } }
	@keyframes fadeIn { from { opacity: 0; } }
	/* ===== 13 Navegación inferior (móvil) ===== */
	.bottom-nav{
	  position: fixed !important; left: 0 !important; right: 0 !important; bottom: 0 !important; transform: none !important; z-index: 9999;
	  padding-bottom: calc(8px + env(safe-area-inset-bottom));
	  display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
	}
	.bottom-nav .nav-btn{
	  appearance: none; border: 0; cursor: pointer; width: 100%; height: 48px; display: grid; place-items: center;
	  border-radius: 14px; color: #e5e7eb; background: rgba(255,255,255,.08);
	  box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
	}
	.bottom-nav .nav-btn.is-active{ outline: 2px solid var(--cyan); outline-offset: 0; }
	.bottom-nav .nav-btn.is-primary{
	  transform: translateY(-2px) scale(1.06);
	  background: linear-gradient(90deg, var(--cyan), var(--violet));
	  color: white;
	  box-shadow: 0 12px 28px rgba(16,181,255,.22), 0 12px 28px rgba(94,91,255,.22);
	}
	.app-wrap{ grid-auto-rows: minmax(min-content, max-content); }
	.logout-top{ display: none; margin-left: auto; }
	@supports not (padding: max(0px)){
		body:not(.login-mode):not(.setup-mode) .auth-head{ padding-top: calc(14px + constant(safe-area-inset-top)); }
	}
	@media (min-width:980px){ .app-wrap{ grid-template-columns: 1.1fr .9fr; align-items:start; gap:24px } }
	@media (max-width:760px){ .grid2{ grid-template-columns:1fr } }
	@media (min-width:480px){ .cal-grid{ gap:8px } .cal-cell{ border-radius:16px; padding:8px 8px 12px } .dot{ width:7px; height:7px } }
	@media (min-width:768px){ .cal-cell{ aspect-ratio: 1 / .9; padding:10px 10px 14px; border-radius:16px } .cal-num{ font-size:clamp(13px, 1.6vw, 16px) } .dot{ width:7px; height:7px } }
	@media (min-width:1100px){ .cal-cell{ aspect-ratio: 1 / .85 } }
	@media (max-width:560px){ .day-toolbar{ flex-wrap:wrap; row-gap:12px; } #dayTitle{ flex:1 0 100%; } #btnNewEvent{ margin-left:0; } #btnNewEvent{ margin-left:auto; } }
	@supports(padding:max(0px)){ .app-wrap{ padding-bottom: max(20px, calc(76px + env(safe-area-inset-bottom))); } }
	@media (max-width: 980px){
		.bottom-nav{ display: grid; }
		.app-wrap{ padding-bottom: max(20px, calc(88px + env(safe-area-inset-bottom))); }
		body:not(.login-mode):not(.setup-mode) .logout-top{
			display: inline-flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,.35);
			background: #fff; color: #0b1220; font-weight: 800; padding: 8px 10px; border-radius: 12px;
		}
		.footer #logout{ display: none !important; }
		.app-section{ display: none !important; }
		body[data-tab="agenda"] [data-section="agenda"]{ display:block !important; }
		body[data-tab="send"] [data-section="send"]{ display:block !important; }
		body[data-tab="contacts"] [data-section="contacts"]{ display:block !important; }
        body[data-tab="templates"] [data-section="templates"]{ display:block !important; }
		body[data-tab="backups"] [data-section="backups"]{ display:block !important; }
		#agendaCard.span-2{ grid-column: 1 / -1; }
	}
	@media (min-width: 981px){
		.bottom-nav{ display: none !important; }
		.app-wrap{ row-gap: 24px !important; }
		.app-wrap > .glass{ margin-top: 0; }
		.app-wrap > .glass:nth-child(n + 2){ margin-top: 24px; }
	}
	@supports (-webkit-touch-callout: none) {
	  @media (display-mode: standalone) {
		.bottom-nav{ position: fixed !important; bottom: 0 !important; padding-bottom: calc(88px + env(safe-area-inset-bottom)); }
		.app-wrap{ padding-bottom: max(20px, calc(88px + env(safe-area-inset-bottom))) !important; }
	  }
	  @media (display-mode: standalone) {
		.bottom-nav{ padding-bottom: calc(88px + constant(safe-area-inset-bottom)); }
		.app-wrap{   padding-bottom: max(20px, calc(88px + constant(safe-area-inset-bottom))) !important; }
	  }
	}
	html, body, #appView, .card { transform: none !important; filter: none !important; }
	body { overscroll-behavior-y: contain; }
	html.standalone .bottom-nav{ position: fixed !important; left: 0 !important; right: 0 !important; bottom: 0 !important; transform: none !important; padding-bottom: calc(88px + env(safe-area-inset-bottom)); }
	html.standalone .app-wrap{ padding-bottom: max(20px, calc(88px + env(safe-area-inset-bottom))) !important; }
	/* ===== 14 Footer/Logout ===== */
	.logout{ color:#ffb4b4; text-decoration:underline; cursor:pointer; font-weight:800 }
	/* ===== 15 Animaciones ===== */
	@keyframes glowTitle{ 0% { text-shadow: 0 0 0 rgba(16,181,255,0); } 50% { text-shadow: 0 0 16px rgba(16,181,255,.6); } 100% { text-shadow: 0 0 0 rgba(16,181,255,0); } }
	.flash{ animation: glowTitle 360ms ease-out; }
	/* ===== 16 Utilidades ===== */
	.muted{ color:#cbd5e1; font-size:14px }
	mark{ background:#fff5b1; padding:0 2px; border-radius:4px }
	.footer{ padding:18px 16px 36px 16px; display:flex; justify-content:center; align-items:center }
	/* ===== 17 Miscelánea ===== */
	.card{ width:min(1120px, 100%); margin:0 auto; background:transparent; }
	.main{ padding:0; }
	.stage{ display:none; }
	@media (max-width: 980px){
	  body{ height: 100svh; overflow: hidden; }
	  .card{ position: fixed; inset: 0; display: flex; flex-direction: column; }
	  .main{ flex: 1 1 auto; min-height: 0; overflow: auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(88px + env(safe-area-inset-bottom)) !important; }
	  #bottomNav.bottom-nav{
		position: fixed !important; left: 0 !important; right: 0 !important; bottom: 0 !important; transform: none !important; z-index: 9999;
		display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 16px 12px 32px;
		background: rgba(8,12,24,.45); -webkit-backdrop-filter: blur(12px) saturate(120%); backdrop-filter: blur(12px) saturate(120%);
		border: 0 !important; box-shadow: 0 -1px 0 rgba(255,255,255,.14) inset; isolation: isolate;
	  }
	  #bottomNav.bottom-nav::after{
		content: ""; position: absolute; left: 0; right: 0; bottom: calc(-1 * env(safe-area-inset-bottom));
		height: env(safe-area-inset-bottom); background: rgba(8,12,24,.45); pointer-events: none;
	  }
	  #bottomNav .nav-btn{ height: 48px; display: grid; place-items: center; }
	}
	@supports (-webkit-touch-callout: none){
	  @media (max-width: 980px){
		.main{ padding-bottom: calc(88px + constant(safe-area-inset-bottom)) !important; }
		#bottomNav.bottom-nav::after{ bottom: calc(-1 * constant(safe-area-inset-bottom)); height: constant(safe-area-inset-bottom); }
	  }
	}
    /* ===== 18. Nuevos Estilos para Vista Semanal y Plantillas (CORREGIDO) ===== */
	.cal-head {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
		align-items: center;
		gap: 12px;
		margin-bottom: 12px;
	}
	.cal-title {
		width: 100%;
		text-align: center;
		order: 1;
	}
	.cal-view-switcher {
		order: 2;
		margin-right: auto;
	}
	.cal-nav-group {
		display: flex;
		gap: 8px;
		align-items: center;
		order: 3;
	}
	.cal-view-switcher .chip { padding: 6px 12px; font-size: 14px; }
	.chip.is-active { background: var(--violet); color: white; border-color: var(--violet); }

	/* --- Estilos de Vista Semanal Reconstruidos --- */
	.cal-grid-weekly {
		display: grid;
		grid-template-columns: 50px repeat(7, 1fr); /* 1 col para hora + 7 para días */
		grid-template-rows: auto; /* Cabecera de días se ajusta sola */
		margin-top: 16px;
		position: relative;
		background: rgba(0,0,0,.1);
		border-radius: 16px;
		overflow-x: auto;
	}
	.cal-weekly-header {
		text-align: center;
		padding: 8px 4px;
		font-weight: 800;
		color: #c7d2fe;
		font-size: clamp(11px, 2.6vw, 13px);
		border-bottom: 1px solid var(--glassBorder);
		position: sticky; top: 0;
		background: rgba(15, 28, 54, 0.9);
		backdrop-filter: blur(4px);
		z-index: 20;
		min-width: 40px;
	}
	.cal-weekly-header.is-today { color: var(--cyan); }
	.cal-weekly-header-time { grid-column: 1; grid-row: 1; }

	.cal-weekly-times {
		grid-column: 1;
		grid-row: 2 / -1; /* Ocupa todas las filas de horas */
		z-index: 10;
		padding-right: 8px;
		border-right: 1px solid var(--glassBorder);
	}
	.cal-weekly-time-slot {
		height: 40px; /* Altura para cada 30 min */
		position: relative;
		text-align: right;
		font-size: 11px;
		color: #94a3b8;
		padding-top: 2px;
	}

	.cal-weekly-day-col {
		position: relative;
		grid-row: 2 / -1; /* Ocupa todas las filas de horas */
		border-left: 1px solid var(--glassBorder);
		background-image: linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px);
		background-size: 100% 40px; /* Línea por cada 30 min */
	}
	.cal-weekly-day-col.is-today-col { background-color: rgba(16,181,255,.05); }

	.cal-weekly-event {
		position: absolute;
		background: rgba(255,255,255,.9);
		border-radius: 8px;
		padding: 4px 6px;
		overflow: hidden;
		font-size: 12px;
		color: var(--ink);
		box-shadow: 0 4px 10px rgba(0,0,0,.2);
		border-left: 4px solid var(--violet);
		cursor: pointer;
		transition: all .2s ease;
		z-index: 15;
		left: 2px; right: 2px;
	}
	.cal-weekly-event:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,.25); }

	.evt-weekly-title { font-weight: 800; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
	.evt-weekly-meta { font-size: 11px; opacity: .7; }

	/* Estilos para la sección de Plantillas (sin cambios) */
	.template-card {
		background: #fff; color: var(--ink); border-radius: 14px;
		padding: 16px; margin-top: 12px; box-shadow: 0 10px 22px rgba(0,0,0,.14);
	}
	.template-header { display: flex; justify-content: space-between; align-items: center; }
	.template-name { font-weight: 800; font-size: 18px; }
	.template-content {
		margin-top: 8px; white-space: pre-wrap; background: #f8f9fa;
		padding: 10px; border-radius: 8px; font-family: monospace;
		font-size: 14px; max-height: 150px; overflow-y: auto;
	}
	.template-actions { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end; }
	.template-tip { font-size: 13px; margin-top: 12px; color: #c7d2fe; }

	/* Ajuste para 5 iconos en la barra inferior */
	@media (max-width: 980px) {
		#bottomNav.bottom-nav {
			grid-template-columns: repeat(5, 1fr);
		}
	}
	
	/* ===== 19. Estilos para el botón de importar contacto ===== */
	.field-with-button {
	  position: relative;
	}
	
	.field-with-button input[type="search"] {
	  padding-right: 80px !important; 
	}
	.btn-import-contact {
	  display: none; 
	  position: absolute;
	  top: 50%;
	  right: 42px; 
	  transform: translateY(-50%);
	  padding: 4px;
	  background: transparent;
	  border: none;
	  cursor: pointer;
	  color: #667085;
	  opacity: 0.8;
	  transition: all .2s ease;
	}
	.btn-import-contact:hover {
	  opacity: 1;
	  color: var(--violet);
	}
	
	body.contact-picker-supported .btn-import-contact {
	  display: block;
	}
</style>
</head>
<body>
  <div class="card">
    <div class="auth-head">
      <div class="logo-box"><img src="icons/icon-192.png" alt="Logo" /></div>
      <div>
        <h1 id="hdrTitle" class="title">Iniciar sesión</h1>
        <p class="subtitle">MF Gestor de Citas</p>
      </div>
		<button id="logoutTop" class="chip logout-top" type="button" aria-label="Cerrar sesión" title="Cerrar sesión">
		  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 7V5a2 2 0 0 1 2-2h5a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2v-2" /><path d="M15 12H3m4-4-4 4 4 4" /></g></svg>
		</button>
    </div>
    <div class="hr"></div>

    <main id="main" class="main">
      <section id="setupView" class="stage">
        <div class="login-hero">
          <div class="login-card">
            <div class="login-logo-wrap">
              <div class="login-logo-circle"><img src="icons/icon-192.png" alt="MF"></div>
            </div>
            <h2 class="login-title">Bienvenido/a</h2>
            <p class="login-sub">Crea tu cuenta local para empezar</p>
            <div class="login-fields">
              <div class="field login-field">
                <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
                <input id="setupUser" placeholder="Usuario" autocomplete="username">
              </div>
              <div class="field login-field">
                <svg class="icon-left" viewBox="0 0 24 24" fill="none"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="11" width="14" height="10" rx="2"></rect><path d="M7 11V8a5 5 0 0 1 10 0v3"></path></g></svg>
                <input id="setupPass" type="password" placeholder="Contraseña (mín. 6 caracteres)" autocomplete="new-password">
                <svg id="toggleSetup" class="icon-right" viewBox="0 0 24 24" fill="none" aria-label="Mostrar/Ocultar"></svg>
              </div>
              <button id="btnSetup" class="btn" type="button">Crear y acceder</button>
            </div>
          </div>
        </div>
      </section>

      <section id="loginView" class="stage">
        <div class="login-hero">
          <div class="login-card">
            <div class="login-logo-wrap">
              <div class="login-logo-circle"><img src="icons/icon-192.png" alt="MF"></div>
            </div>
            <h2 class="login-title">Iniciar sesión</h2>
            <p class="login-sub">MF Gestor de Citas</p>
            <div class="login-fields">
              <div class="field login-field">
                <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
                <input id="loginUser" placeholder="Usuario" autocomplete="username">
              </div>
              <div class="field login-field">
                <svg class="icon-left" viewBox="0 0 24 24" fill="none"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="11" width="14" height="10" rx="2"></rect><path d="M7 11V8a5 5 0 0 1 10 0v3"></path></g></svg>
                <input id="loginPass" type="password" placeholder="Contraseña" autocomplete="current-password">
                <svg id="toggleLogin" class="icon-right" viewBox="0 0 24 24" fill="none" aria-label="Mostrar/Ocultar"></svg>
              </div>
              <button id="btnLogin" class="btn" type="button">Entrar</button>
			  
              <button id="btnReset" class="btn-ghost" type="button" style="display:none">Borrar datos de la app</button>
            </div>
          </div>
        </div>
      </section>

      <section id="appView" class="stage" style="display:none">
        <div class="app-wrap">

          <div class="glass span-2 app-section" id="agendaCard" data-section="agenda">
			<div class="cal-head">
			  <div class="cal-title" id="calTitle">Agenda</div>
			  <div class="cal-view-switcher">
				<button class="chip is-active" id="viewMonth" type="button">Mes</button>
				<button class="chip" id="viewWeek" type="button">Semana</button>
			  </div>
			  <div class="cal-nav-group">
				<div class="cal-nav">
				  <button class="chip" id="calPrev" type="button">◀︎</button>
				  <button class="chip" id="calToday" type="button">Hoy</button>
				  <button class="chip" id="calNext" type="button">▶︎</button>
				</div>
				<button class="btn-small btn-outline" id="btnNewEvent" type="button">Nueva cita</button>
			  </div>
			</div>
			<div class="cal-grid" id="calGrid"></div>
			<div class="cal-grid-weekly" id="calGridWeekly" style="display: none;"></div>

			<div class="day-toolbar" id="dayToolbar">
				<div class="toggle" id="gcalRow" style="display:flex; align-items:center; gap:10px; margin:6px 0 10px; width: 100%;">
				  <input id="gCalAutoToggle" type="checkbox" disabled />
				  <span class="muted">Añadir nuevas citas a Google Calendar</span>
				  <button id="btnGConnect" class="btn-small btn-outline" type="button" style="margin-left:auto">Conectar Google</button>
				  <span id="gStatus" class="muted" style="opacity:.85"></span>
				</div>
			  <div class="section-title" id="dayTitle" style="margin:0">Hoy</div>
			</div>
            <div id="dayList" class="day-list"></div>
          </div>

          <div class="glass app-section" data-section="send">
            <h3 class="section-title">Enviar cita</h3>
            <div class="grid2">
              <div>
                <label for="dt">Fecha y hora del recordatorio</label>
                <div class="field"><input id="dt" type="datetime-local" /></div>
              </div>
              <div>
                <label for="contactSearch">Contacto</label>
                <div class="contact-picker">
                  <div class="field field-with-button">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79L20 20.5 21.5 19l-6-6ZM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14Z" fill="currentColor"/></svg>
                    <input id="contactSearch" type="search" placeholder="Buscar por nombre o teléfono" autocapitalize="none" autocomplete="off" spellcheck="false" />
                    <svg id="clearSearch" class="icon-right" viewBox="0 0 24 24" fill="none"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4l-6.3 6.3-1.41-1.42L9.17 12 2.88 5.71 4.29 4.3l6.3 6.29 6.29-6.3 1.42 1.42Z" fill="currentColor"/></svg>
                    <button type="button" id="btnImportContactSend" class="btn-import-contact" title="Importar contacto del dispositivo">
					  <svg viewBox="0 0 24 24" width="24" height="24">
						<path fill="currentColor" d="M19.5 2H7.5C6.12 2 5 3.12 5 4.5v15C5 20.88 6.12 22 7.5 22h12c1.38 0 2.5-1.12 2.5-2.5v-15C22 3.12 20.88 2 19.5 2zM7 6h1V5H7v1zm0 5h1v-1H7v1zm0 5h1v-1H7v1zm11-8a2 2 0 1 1-4 0a2 2 0 0 1 4 0zm-1 3h-4c-1.1 0-2 .9-2 2v1.5h8V14c0-1.1-.9-2-2-2z" />
					  </svg>
					</button>
                  </div>
                  <div id="contactResults" role="listbox" aria-label="Resultados de contactos" hidden></div>
                </div>
              </div>
            </div>
             <div style="margin-top:14px">
              <label for="templateSelectSend">Plantilla de Mensaje (Opcional)</label>
              <div class="field"><select id="templateSelectSend"></select></div>
            </div>
            <div style="margin-top:14px">
              <label for="msg">Mensaje</label>
              <div class="field"><textarea id="msg" rows="4" placeholder="Selecciona una plantilla o escribe tu mensaje. Usa {NOMBRE} para el nombre del contacto."></textarea></div>
            </div>
            <div style="margin-top:16px">
              <button id="btnSend" class="btn" type="button">Enviar Cita</button>
            </div>
          </div>

          <div class="glass app-section" data-section="contacts">
            <div>
			  <h3 class="section-title" style="margin-bottom:10px">Gestionar contactos</h3>
			  <div class="grid2 gc-split">
				<div>
				  <div class="field"><input id="newName" placeholder="Nombre" /></div>
				  <div class="field" style="margin-top:10px">
					<input id="newPhone" type="tel" inputmode="tel" autocomplete="tel" enterkeyhint="done" pattern="^\\+\\d{6,15}$" placeholder="+34600111222" />
				  </div>
				  <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap">
					<button id="btnAdd" class="btn btn-outline" type="button">Añadir contacto</button>
				  </div>
				</div>
				<div>
				  <div class="section-subtitle">Seleccionar un contacto</div>
				  <div class="field"><select id="contactSelect"></select></div>
				  <div id="selectedContactCard" class="contact-card" hidden>
					<div class="contact-row">
					  <div>
						<div class="contact-name" id="scName">—</div>
						<div class="contact-phone" id="scPhone">—</div>
					  </div>
					  <div class="contact-actions">
						<button id="scEdit"  class="btn-small btn-outline" type="button" aria-label="Editar contacto">Editar</button>
						<button id="scDelete" class="btn-small btn-danger"  type="button" aria-label="Eliminar contacto">Eliminar</button>
					  </div>
					</div>
				  </div>
				</div>
			  </div>
			  <div class="gc-sep"></div>
			</div>
		  </div>

          <div class="glass app-section" data-section="templates">
            <h3 class="section-title">Plantillas de Mensajes</h3>
            <div class="glass" style="background: rgba(0,0,0,.1);">
                <h4 class="section-title" id="templateFormTitle">Nueva Plantilla</h4>
                <input type="hidden" id="templateId" />
                <div class="field">
                    <input id="templateName" placeholder="Nombre de la plantilla (ej. Recordatorio 24h)" />
                </div>
                <div class="field" style="margin-top: 10px;">
                    <textarea id="templateContent" rows="4" placeholder="Escribe el contenido del mensaje..."></textarea>
                </div>
                <div class="modal-actions">
                    <button id="btnSaveTemplate" class="btn" type="button">Guardar Plantilla</button>
                    <button id="btnCancelEditTemplate" class="btn btn-outline" type="button" style="display: none;">Cancelar Edición</button>
                </div>
				<p class="template-tip"><b>Consejo:</b> Puedes usar <code>{NOMBRE}</code> en tu texto y será reemplazado por el nombre del contacto.</p>
            </div>
            <div id="templateList" style="margin-top: 24px;"></div>
          </div>
		  
		  <div class="glass app-section" data-section="backups">
            <div>
              <h3 class="section-title" style="margin-bottom:10px">Copias de seguridad</h3>
			  <h4>Contactos</h4>
              <div style="display:flex; flex-wrap:wrap; gap:12px">
                <button id="btnExportFixed" class="btn btn-outline" type="button">Exportar contactos (.json)</button>
                <button id="btnExportCsv" class="btn btn-outline" type="button">Exportar CSV</button>
                <button id="btnImportApp" class="btn btn-outline" type="button">Importar contactos…</button>
				<button id="btnImportDevice" class="btn btn-outline" type="button" style="display:none;">Importar del dispositivo</button>
              </div>
			  <!--<p class="muted" style="font-size:12px; margin-top:8px;">
				⚠️ La exportación `.json` usa una clave fija para facilitar la restauración. Guarda el archivo en un lugar seguro.
			  </p>-->
              <div class="toggle" style="margin-top:12px">
                <input id="autoBackupToggle" type="checkbox" />
                <span class="muted">Auto-descargar copia tras cada cambio de contactos</span>
              </div>
              <div id="autoBackupToast" class="muted" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; background:rgba(16,181,255,.08); border:1px solid rgba(16,181,255,.25)">
                Copia creada. <button id="btnDownloadAuto" type="button" class="btn-small btn-outline">Descargar ahora</button>
              </div>
			  <h4>Agenda</h4>
              <div style="display:flex; flex-wrap:wrap; gap:12px">
				<button id="btnExportAgenda" class="btn btn-outline" type="button">Exportar agenda (.json)</button>
				<button id="btnImportAgenda" class="btn btn-outline" type="button">Importar agenda…</button>
              </div>
              <div class="toggle" style="margin-top:8px">
				  <input id="autoBackupCalToggle" type="checkbox" />
				  <span class="muted">Auto-descargar copia tras cambios en la agenda</span>
			  </div>
			  <div id="autoCalBackupToast" class="muted" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; background:rgba(16,181,255,.08); border:1px solid rgba(16,181,255,.25)">
				Copia de agenda creada. <button id="btnDownloadAutoCal" type="button" class="btn-small btn-outline">Descargar ahora</button>
			  </div>
			  <h4>Copia Completa</h4>
			  <div style="display:flex; flex-wrap:wrap; gap:12px">
				<button id="btnExportFull" class="btn btn-outline" type="button">Exportar todo (.json)</button>
				<button id="btnImportFull" class="btn btn-outline" type="button">Importar todo…</button>
              </div>
            </div>
			<div class="gc-sep"></div>
			  <div id="autoBackupContainer" style="display:none; margin-top:12px;">
				<h3 class="section-title" style="margin-bottom:10px">Guardado Automático Persistente</h3>
				<p class="muted" style="font-size:13px; margin-top:-8px; margin-bottom:12px;">
				  Guarda una copia de seguridad automáticamente.
				</p>
				<div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
				  <button id="btnAutoBackupSetup" class="btn btn-outline" type="button">Activar…</button>
				  <span id="autoBackupStatus" class="muted" style="font-size:12px;"></span>
				</div>
			  </div>
			  
			  <div class="gc-sep"></div>

			  <div id="biometricSection" style="display: none; margin-top: 12px;">
				  <h3 class="section-title" style="margin-bottom:10px">Acceso Biométrico</h3>
				  <p class="muted" style="font-size:13px; margin-top:-8px; margin-bottom:12px;">
					Activa el inicio de sesión con tu huella dactilar o reconocimiento facial 
				  </p>
				  <div id="biometricStatus"></div>
			  </div>
			</div>
          </div>
        </div>

		<nav class="bottom-nav" id="bottomNav" aria-label="Secciones">
		  <button class="nav-btn" data-tab="contacts" aria-label="Contactos" title="Contactos">
			<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.4 0-7 2.2-7 5v1h14v-1c0-2.8-2.6-5-7-5Z"/></svg>
		  </button>
		  <button class="nav-btn" data-tab="send" aria-label="Enviar" title="Enviar cita">
			<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path fill="currentColor" d="m2 21 20-9L2 3v6l14 3L2 15z"/></svg>
		  </button>
		  <button class="nav-btn is-primary" data-tab="agenda" aria-label="Agenda" title="Agenda">
			<svg viewBox="0 0 24 24" width="32" height="32" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M7 2v3M17 2v3M3.5 9h17"/><rect x="3.5" y="5" width="17" height="16" rx="2"/></g></svg>
		  </button>
		  <button class="nav-btn" data-tab="templates" aria-label="Plantillas" title="Plantillas de Mensajes">
            <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path fill="currentColor" d="M6 2h10l4 4v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm5 10H8v2h3v-2zm5-4H8v2h8V8z"/></svg>
		  </button>
		  <button class="nav-btn" data-tab="backups" aria-label="Copias" title="Copias de seguridad">
			<svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true"><path fill="currentColor" d="M12 6a6 6 0 1 1-5.3 3.1l1.3.75A4.5 4.5 0 1 0 12 7.5V10l4-3-4-3v2Z"/></svg>
		  </button>
		</nav>
        <div class="footer"><span id="logout" class="logout" style="display:none">Cerrar sesión</span></div>
      </section>
    </main>
  </div>

  <dialog id="eventModal" class="modal">
    <form method="dialog" class="modal-card" id="evtForm" onsubmit="return false;">
      <div class="modal-head">
        <div class="modal-title" id="evtModalTitle">Nueva cita</div>
        <button type="button" id="evtClose" class="chip">Cerrar</button>
      </div>
      
      <input type="hidden" id="evtId" />

      <div class="field" style="margin-bottom:10px">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M6 7h12M6 12h12M6 17h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="evtTitle" placeholder="Título de la cita" />
      </div>

      <div class="grid2" style="margin-bottom:10px">
        <div class="field" id="evtStart-field">
          <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M7 2v3M17 2v3M3.5 9h17M6 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="evtStart" type="datetime-local" />
        </div>
        <div class="field" id="evtEnd-field">
          <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M7 2v3M17 2v3M3.5 9h17M6 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="evtEnd" type="datetime-local" />
        </div>
      </div>

      <div class="contact-picker" style="margin-bottom:10px">
        <div class="field field-with-button">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79L20 20.5 21.5 19l-6-6ZM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14Z" fill="currentColor"/></svg>
          <input id="evtSearch" type="search" placeholder="Buscar contacto (opcional)" autocapitalize="none" autocomplete="off" spellcheck="false" />
          <svg id="evtClear" class="icon-right" viewBox="0 0 24 24" fill="none"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4l-6.3 6.3-1.41-1.42L9.17 12 2.88 5.71 4.29 4.3l6.3 6.29 6.29-6.3 1.42 1.42Z" fill="currentColor"/></svg>
          <button type="button" id="btnImportContactModal" class="btn-import-contact" title="Importar contacto del dispositivo">
			<svg viewBox="0 0 24 24" width="24" height="24">
				<path fill="currentColor" d="M19.5 2H7.5C6.12 2 5 3.12 5 4.5v15C5 20.88 6.12 22 7.5 22h12c1.38 0 2.5-1.12 2.5-2.5v-15C22 3.12 20.88 2 19.5 2zM7 6h1V5H7v1zm0 5h1v-1H7v1zm0 5h1v-1H7v1zm11-8a2 2 0 1 1-4 0a2 2 0 0 1 4 0zm-1 3h-4c-1.1 0-2 .9-2 2v1.5h8V14c0-1.1-.9-2-2-2z" />
			</svg>
		  </button>
        </div>
        <div id="evtResults" role="listbox" aria-label="Resultados de contactos" hidden></div>
        <select id="evtContact" style="display:none"></select>
      </div>

      <div class="field">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M4 5h16v14l-8-4-8 4V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <textarea id="evtNote" rows="3" placeholder="Notas"></textarea>
      </div>
	  <div class="field" style="margin-top:10px">
		<svg class="icon-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
		<select id="templateSelectModal">
			<option value="">Usar plantilla para notas...</option>
		</select>
	  </div>
	  <div class="field" style="margin-top:10px">
		<svg class="icon-left" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6a6 6 0 1 1-5.3 3.1l1.3.75A4.5 4.5 0 1 0 12 7.5V10l4-3-4-3v2Z"/></svg>
		<select id="evtRecurrence">
			<option value="none">No se repite</option>
			<option value="daily">Cada día</option>
			<option value="weekly">Cada semana</option>
			<option value="monthly">Cada mes</option>
		</select>
	  </div>

      <div class="modal-actions">
        <button id="evtSave" class="btn" type="button">Guardar</button>
        <button id="evtSend" class="btn btn-outline" type="button">Enviar cita</button>
        <button id="evtDelete" class="btn btn-danger" type="button" style="margin-left:auto; display:none">Eliminar</button>
      </div>
      
      <div id="modalToastContainer" class="toast-container" style="position: absolute; width: auto;"></div>

    </form>
  </dialog>

  <div id="toastContainer" class="toast-container"></div>

  <dialog id="confirmModal" class="modal">
	<div class="modal-card">
		<h3 id="confirmTitle" class="section-title" style="text-align:center;">Confirmar acción</h3>
		<p id="confirmMessage" class="muted" style="text-align:center; margin: 8px 0 16px;"></p>
		<div class="modal-actions" style="justify-content:center;">
			<button id="confirmCancel" class="btn btn-outline" style="width:auto; padding: 12px 24px;">Cancelar</button>
			<button id="confirmOk" class="btn" style="width:auto; padding: 12px 24px;">Aceptar</button>
		</div>
	</div>
  </dialog>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
// ===== UTILITIES =====
	const $ = id => document.getElementById(id);
    const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const ubuf = s => Uint8Array.from(atob(s), c=>c.charCodeAt(0)).buffer;
	const debounce = (fn, delay) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), delay); }; };

	const showToast = (message, type = 'info', duration = 3000, context = 'global') => {
		const container = (context === 'modal') ? $('modalToastContainer') : $('toastContainer');
		if (!container) return;
		const toast = document.createElement('div');
		toast.className = `toast ${type}`;
		toast.textContent = message;
		container.appendChild(toast);
		setTimeout(() => { toast.remove(); }, duration);
	};

	const showConfirmation = (title, message) => {
		return new Promise(resolve => {
			const modal = $('confirmModal');
			$('confirmTitle').textContent = title;
			$('confirmMessage').textContent = message;

			const onOk = () => { cleanup(); resolve(true); };
			const onCancel = () => { cleanup(); resolve(false); };
			const cleanup = () => {
				$('confirmOk').removeEventListener('click', onOk);
				$('confirmCancel').removeEventListener('click', onCancel);
				modal.close();
			};

			$('confirmOk').addEventListener('click', onOk);
			$('confirmCancel').addEventListener('click', onCancel);

			modal.showModal();
		});
	};

	const toggleLoading = (button, isLoading, originalContent = '') => {
		if (!button) return;
		if (isLoading) {
			button.dataset.original = button.innerHTML;
			button.innerHTML = '<div class="spinner"></div>';
			button.disabled = true;
		} else {
			button.innerHTML = button.dataset.original || originalContent;
			button.disabled = false;
		}
	};
	
	// ===== INDEXEDDB KEY-VALUE STORE =====
	const idbKeyval = (() => {
		function getDB() {
			return new Promise((resolve, reject) => {
				const request = indexedDB.open('mf-gestor-citas-db', 1);
				request.onupgradeneeded = () => request.result.createObjectStore('keyval');
				request.onsuccess = () => resolve(request.result);
				request.onerror = () => reject(request.error);
			});
		}
		return {
			get: async (key) => {
				const db = await getDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction('keyval', 'readonly');
					const store = tx.objectStore('keyval');
					const request = store.get(key);
					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(tx.error);
				});
			},
			set: async (key, value) => {
				const db = await getDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction('keyval', 'readwrite');
					const store = tx.objectStore('keyval');
					store.put(value, key);
					tx.oncomplete = () => resolve();
					tx.onerror = () => reject(tx.error);
				});
			},
			del: async (key) => {
				const db = await getDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction('keyval', 'readwrite');
					const store = tx.objectStore('keyval');
					store.delete(key);
					tx.oncomplete = () => resolve();
					tx.onerror = () => reject(tx.error);
				});
			}
		};
	})();


	// ===== STATE MANAGEMENT MODULE =====
	const S = (() => {
		let key = null;
		let user = null;
		const stateKey = 'wa-reminders-app-v1';

		const getState = () => { const v = localStorage.getItem(stateKey); return v ? JSON.parse(v) : null; };
		const saveState = (o) => { localStorage.setItem(stateKey, JSON.stringify(o)); };

		return {
			state: getState,
			save: saveState,
			clear: () => { localStorage.removeItem(stateKey); key = null; user = null; },
			setKey: (k) => { key = k; },
			getKey: () => key,
			setUser: (u) => { user = u; },
			getUser: () => user,
		};
	})();

	// ===== CRYPTO =====
    async function derive(password, saltB64){
      const salt=saltB64?ubuf(saltB64):crypto.getRandomValues(new Uint8Array(16)).buffer;
      const baseKey=await crypto.subtle.importKey('raw', new TextEncoder().encode(password),'PBKDF2',false,['deriveBits']);
      const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:250000,hash:'SHA-256'},baseKey,256);
      const keyBytes=new Uint8Array(bits);
      const pwHash=await crypto.subtle.digest('SHA-256', keyBytes);
      const aesKey=await crypto.subtle.importKey('raw', keyBytes,{name:'AES-GCM'},false,['encrypt','decrypt']);
      return {aesKey, pwHashB64:b64(pwHash), saltB64:b64(salt)};
    }
    async function encryptJson(aesKey,obj){ const iv=crypto.getRandomValues(new Uint8Array(12)); const data=new TextEncoder().encode(JSON.stringify(obj)); const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},aesKey,data); return {iv:b64(iv),ct:b64(ct)}; }
    async function decryptJson(aesKey,pack){ const iv=ubuf(pack.iv), ct=ubuf(pack.ct); const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(iv)},aesKey,ct); return JSON.parse(new TextDecoder().decode(pt)); }

    const FIXED_PASS = 'MFGestorCitas';
    async function deriveFixed(saltB64){ return derive(FIXED_PASS, saltB64); }

	// ===== FILE & EXTERNAL UTILS =====
    async function saveFileSmart(filename, mime, content){
      let blob = new Blob([content], {type: mime});
      try {
        if (navigator.canShare && 'share' in navigator) {
          const file = new File([blob], filename, {type: mime});
          if (navigator.canShare({files: [file]})) { await navigator.share({files: [file], title: filename}); return true; }
        }
      } catch(e) {}
      try {
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = filename;
		document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1200); return true;
      } catch(e) {}
      showToast('No se pudo descargar el archivo.', 'error'); return false;
    }
    const saveJson = (name, obj) => saveFileSmart(name, 'application/json', JSON.stringify(obj, null, 2));
    const saveCsv  = (name, csv) => saveFileSmart(name, 'text/csv;charset=utf-8', '\uFEFF' + csv);

    function openExternal(url){
      window.location.href = url;
    }

	// ===== UI LOGIC =====
    function setHeaderTitle(t){ const h=$('hdrTitle'); if(h) h.textContent=t; }
    function toggleResetVisibility(){ const reset=$('btnReset'); if(reset) reset.style.display = S.state() ? 'inline-flex' : 'none'; }
    function show(id){
      ['setupView','loginView','appView'].forEach(v=>{ const el=$(v); if(el) el.style.display=(v===id?'block':'none'); });
      $('logout').style.display = id==='appView' ? 'inline' : 'none';
      setHeaderTitle(id==='appView' ? 'Gestionar citas' : 'Iniciar sesión');
      toggleResetVisibility();
      document.body.classList.toggle('login-mode', id==='loginView');
      document.body.classList.toggle('setup-mode', id==='setupView');
      window.scrollTo(0,0);
      if (id === 'appView') {
        renderTemplates();
        populateTemplateSelectors();
		updateAutoBackupStatus();
		webAuthn.updateUi();
      }
	  if (id === 'loginView') {
        webAuthn.initConditionalLogin();
      }
    }
    const isPhoneValid = p => /^\+\d{6,15}$/.test(p);
	const normalizePhoneNumber = (phone) => {
	  if (!phone) return '';
	  let p = phone.trim().replace(/[\s-()]/g, '');
	  if (p.startsWith('00')) p = '+' + p.substring(2);
	  if (!p.startsWith('+') && (p.startsWith('6') || p.startsWith('7')) && p.length === 9) p = '+34' + p;
	  return p;
	};
	
    function diac(s){ return s.normalize('NFD').replace(/\p{Diacritic}+/gu,'').toLowerCase(); }
    function esc(s){ return String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])[ch]); }

	// ===== CONTACT SEARCH & MANAGEMENT =====
    function scoreContact(q, c){
      if(!q) return 1;
      const name = diac(c.name||''), phone = (c.phone||'').replace(/\s+/g,'');
      const qn = diac(q), qd = q.replace(/\D+/g,'');
      let score = -Infinity;
      if(name.includes(qn)) score = Math.max(score, 100 - name.indexOf(qn));
      if(name.startsWith(qn)) score = Math.max(score, 140);
      if(qd && phone.includes(qd)) score = Math.max(score, 120 - phone.indexOf(qd));
      if(qd && phone.startsWith(qd)) score = Math.max(score, 150);
      return score;
    }
    function highlight(text, query){
      if(!query) return esc(text);
      const re = new RegExp('(' + query.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&') + ')','ig');
      return esc(text).replace(re,'<mark>$1</mark>');
    }
    let activeIndex = -1;
    function renderSearchResults(query){
      const box = $('contactResults'); const input=$('contactSearch'); const clear=$('clearSearch');
      if(!box || !input) return;
      const q = query.trim(); clear.style.display = q ? 'block' : 'none';
      const list = (window.__contacts||[]);
      const items = list.map(c => ({ c, s: scoreContact(q, c) })).filter(o => o.s > -Infinity).sort((a,b)=>b.s - a.s).slice(0,60);
      box.innerHTML = ''; activeIndex = -1;
      if(!q){ box.hidden = true; return; }
      if(!items.length){ box.hidden=false; box.innerHTML = `<div class='muted' style='padding:10px;'>Sin resultados</div>`; return; }
      items.forEach((o, idx)=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='result-item'; btn.setAttribute('role','option');
        btn.dataset.phone=o.c.phone; btn.dataset.index=String(idx);
        btn.innerHTML = `<span class="result-name">${highlight(o.c.name, q)}</span> <span class="result-phone">${highlight(o.c.phone, q)}</span>`;
        btn.onclick = ()=>selectContact(o.c);
        btn.onmousemove = ()=>setActive(idx);
        box.appendChild(btn);
      });
      box.hidden = false;
    }
    function setActive(idx){
      const box=$('contactResults'); if(!box) return;
      const items=[...box.querySelectorAll('.result-item')];
      items.forEach(el=>el.setAttribute('aria-selected','false'));
      activeIndex = Math.max(0, Math.min(idx, items.length-1));
      const el = items[activeIndex]; if(el){ el.setAttribute('aria-selected','true'); el.scrollIntoView({block:'nearest'}); }
    }
    function chooseActive(){
      const el = $('contactResults')?.querySelector('.result-item[aria-selected="true"]');
      if(el){ const c = (window.__contacts||[]).find(x=>x.phone===el.dataset.phone); if(c) selectContact(c); }
    }
    function selectContact(c){
	  const sel=$('contactSelect'); if(sel) sel.value = c.phone;
	  $('contactSearch').value = `${c.name} (${c.phone})`;
	  $('contactResults').hidden = true; activeIndex=-1;
	  updateSelectedContactCard(c.phone);
	}
    function wireSearch(){
      const input=$('contactSearch'), box=$('contactResults'), clear=$('clearSearch');
      if(!input || !box) return;
      input.addEventListener('input', debounce(()=>renderSearchResults(input.value), 200));
      input.addEventListener('focus', ()=>renderSearchResults(input.value));
      input.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowDown'){ e.preventDefault(); setActive(activeIndex<0?0:activeIndex+1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); setActive(activeIndex<=0?0:activeIndex-1); }
        else if(e.key==='Enter' && !box.hidden){ e.preventDefault(); chooseActive(); }
        else if(e.key==='Escape'){ box.hidden=true; activeIndex=-1; }
      });
      clear?.addEventListener('click', ()=>{ input.value=''; box.hidden=true; input.focus(); renderSearchResults(''); });
      document.addEventListener('click', (e)=>{ if(!box.hidden && !box.contains(e.target) && e.target!==input) box.hidden=true; });
    }
	function findContactByPhone(phone){ return (window.__contacts || []).find(c => c.phone === phone) || null; }
	function updateSelectedContactCard(phone){
	  const card = $('selectedContactCard'), c = findContactByPhone(phone);
	  if(!card || !c){ card.hidden = true; return; }
	  $('scName').textContent  = c.name || '—';
	  $('scPhone').textContent = c.phone || '—';
	  card.hidden = false;
	  $('scEdit').onclick = ()=>{
		  editingPhone = c.phone || null;
		  $('newName').value = c.name || ''; $('newPhone').value = c.phone || '+34'; $('newName').focus();
		  const addBtn = $('btnAdd'); addBtn.textContent = 'Guardar cambios';
		  if (!$('btnCancelEdit')) {
			const cancel = document.createElement('button'); cancel.id = 'btnCancelEdit';
			cancel.type = 'button'; cancel.className = 'btn-ghost'; cancel.textContent = 'Cancelar';
			cancel.onclick = ()=>{
			  editingPhone = null; $('newName').value = ''; $('newPhone').value = '+34';
			  addBtn.textContent = 'Añadir contacto'; cancel.remove();
			};
			addBtn.parentElement.appendChild(cancel);
		  }
		};
	  $('scDelete').onclick = async ()=>{
		if(!await showConfirmation('Eliminar Contacto', `¿Seguro que quieres eliminar a ${c.name}? Esta acción no se puede deshacer.`)) return;
		const st=S.state(); if(!st||!S.getKey()) return;
		const v = await decryptJson(S.getKey(), st.vault);
		v.list = (v.list || []).filter(x => x.phone !== c.phone);
		st.vault = await encryptJson(S.getKey(), v); S.save(st);
		refreshContactsSelect(v.list);
		updateSelectedContactCard($('contactSelect')?.value || '');
		if(getAutoBackup()) exportFixedBackup(true);
		triggerAutoFsaBackup();
		showToast('Contacto eliminado.', 'success');
	  };
	}
	let editingPhone = null;
	function diacNoCase(s){ return (s||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').toLowerCase(); }
	function sortContacts(list){ return (list||[]).slice().sort((a,b)=>diacNoCase(a.name).localeCompare(diacNoCase(b.name))); }
    function refreshContactsSelect(list){
	  const sorted = sortContacts(Array.isArray(list) ? list : []);
	  window.__contacts = sorted;
	  const sel=$('contactSelect'), msel=$('evtContact');
	  [sel, msel].forEach(s => {
		  if (!s) return;
		  s.innerHTML='';
		  if(sorted.length === 0){ s.add(new Option('— Sin contactos —', '')); }
		  else {
			  if (s === sel) s.add(new Option('— Seleccionar contacto —', ''));
			  sorted.forEach(c=> s.add(new Option(`${c.name} (${c.phone})`, c.phone)));
		  }
	  });
	  renderSearchResults($('contactSearch')?.value || '');
	  updateSelectedContactCard(sel?.value || '');
	}

	
	
	// ===== NUEVA FUNCIÓN: GENERADOR DE ENLACE DE CALENDARIO =====
	/**
	 * Enlace de Data URI con un archivo .ics 
	 * @param {object} evt - El objeto del evento con { title, start, end, note }.
	 * @returns {string|null} - El enlace Data URI o null si el evento es inválido.
	 */
	const generateCalendarLink = (evt) => {
		if (!evt || !evt.start) return null;

		const data = {
			title: evt.title || 'Cita',
			start: new Date(evt.start).getTime(),
			end: evt.end ? new Date(evt.end).getTime() : 0,
			desc: evt.note || `Recordatorio para ${new Date(evt.start).toLocaleString('es-ES')}.`
		};

		const jsonString = JSON.stringify(data);

		// 1. Comprimimos el string a un array de bytes 
		const compressed = pako.deflate(jsonString);

		// 2. Convertimos ese array de bytes a un string Base64.
		
		const binaryString = String.fromCharCode.apply(null, compressed);
		const base64String = btoa(binaryString);

		// 3. Codificamos para que sea seguro en una URL.
		const encoded = base64String
			.replace(/\+/g, '-')
			.replace(/\//g, '_')
			.replace(/=+$/, '');

		const baseUrl = window.location.origin;
		return `${baseUrl}/api/c/${encoded}`;
	};
	
	// ===== MESSAGE BUILDERS =====
    function buildMessage(){
      const v=$('dt')?.value||''; const when=v?new Date(v):new Date();
      const d=when.toLocaleDateString(undefined,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      const t=when.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      return `¡Hola! 👋 Tienes un recordatorio para el ${d} a las ${t}.`;
    }
    function buildEventMessage(evt){
      const when = new Date(evt.start);
      const d=when.toLocaleDateString(undefined,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      const t=when.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      
      let name = evt.contactName || '';
	  if (!name && evt.contactPhone) {
		  const contact = findContactByPhone(evt.contactPhone);
		  if (contact) name = contact.name;
	  }
      
      let mainMessage;
      if (evt.note && evt.note.trim() !== '') {
        mainMessage = applyTemplate(evt.note, name);
      } else {
        const title = evt.title ? `“${evt.title}”` : 'la cita';
        mainMessage = `¡Hola${name?`, ${name}`:''}! 👋 Te recuerdo tu cita ${title} para el ${d} a las ${t}.`;
      }
      
      const calendarLink = generateCalendarLink(evt);
      if (calendarLink) {
        return `${mainMessage}\n\n🗓️ Para añadir esta cita a tu calendario, haz clic en el siguiente enlace:\n${calendarLink}`;
      }

      return mainMessage;
    }

	// ===== IMPORT & SAVE LOCAL CONTACTS =====

	async function importAndSelectContact(onSelectCallback, context = 'global') {
	  if (!('contacts' in navigator && 'select' in navigator.contacts)) {
		showToast('El selector de contactos no es compatible con este navegador.', 'error', 3000, context);
		return;
	  }
	  
	  try {
		const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: false });
		if (!contacts.length) {
		  showToast('No se seleccionó ningún contacto.', 'info', 3000, context);
		  return;
		}
		
		const nativeContact = contacts[0];
		if (!nativeContact.tel || nativeContact.tel.length === 0) {
		  showToast('El contacto seleccionado no tiene número de teléfono.', 'warning', 3000, context);
		  return;
		}
		
		const name = (nativeContact.name && nativeContact.name.length > 0) ? nativeContact.name[0] : 'Sin Nombre';
		const phone = normalizePhoneNumber(nativeContact.tel[0]);

		if (!isPhoneValid(phone)) {
			showToast(`El teléfono "${nativeContact.tel[0]}" no tiene un formato válido.`, 'error', 3000, context);
			return;
		}

		
		const existingContact = (window.__contacts || []).find(c => c.phone === phone);
		
		if (existingContact) {
		  showToast('Este contacto ya existe en tu lista.', 'info', 3000, context);
		  onSelectCallback(existingContact);
		  return;
		}

		const st = S.state();
		if (!st || !S.getKey()) return;
		const vault = await decryptJson(S.getKey(), st.vault);
		const list = vault.list || [];
		
		const newContact = { name, phone };
		list.push(newContact);
		vault.list = sortContacts(list);
		st.vault = await encryptJson(S.getKey(), vault);
		S.save(st);

		refreshContactsSelect(vault.list);
		if (getAutoBackup()) exportFixedBackup(true);
		
		showToast(`Contacto "${name}" importado y guardado.`, 'success', 3000, context);
		onSelectCallback(newContact);

	  } catch (err) {
		console.error("Error al importar contacto:", err);
		showToast('Se canceló la importación o hubo un error.', 'error', 3000, context);
	  }
	}


	// ===== BACKUPS (CONTACTS) =====
    let pendingAutoBackup = null;
    function showAutoToast(show){ $('autoBackupToast').style.display = show ? 'block' : 'none'; }
    async function exportFixedBackup(auto=false){
      const st=S.state(); if(!st || !S.getKey()){ if(!auto) showToast('Inicia sesión para exportar.', 'error'); return; }
      const vault=await decryptJson(S.getKey(), st.vault);
      const {aesKey, saltB64} = await deriveFixed();
      const pack = await encryptJson(aesKey, { list: vault.list || [] });
      const payload = { format: 'mf-contacts-fixed-v1', saltB64, iv: pack.iv, ct: pack.ct, createdAt: new Date().toISOString() };
      const name = auto ? ('autobackup-contactos-' + new Date().toISOString().replace(/[-:T.Z]/g,'').slice(0,14) + '.json') : 'copia-contactos.json';
      if (auto) { pendingAutoBackup = { name, json: JSON.stringify(payload, null, 2) }; showAutoToast(true); }
      else { await saveJson(name, payload); showToast('Copia de contactos exportada.', 'success'); }
    }
    async function importFixedBackupFromFile(file){
      let data; try{ data=JSON.parse(await file.text()); }catch(_){ showToast('Archivo no válido.', 'error'); return; }
      if(!data || data.format!=='mf-contacts-fixed-v1' || !data.ct){ showToast('Copia no reconocida.', 'error'); return; }
      let obj; try{ const {aesKey} = await deriveFixed(data.saltB64); obj = await decryptJson(aesKey, {iv:data.iv, ct:data.ct}); } catch(e){ showToast('No se pudo descifrar la copia.', 'error'); return; }
      if(!obj || !Array.isArray(obj.list)){ showToast('Contenido de copia inválido.', 'error'); return; }

	  const st=S.state(); if(!st || !S.getKey()){ showToast('Inicia sesión para importar.', 'error'); return; }
      const vault=await decryptJson(S.getKey(), st.vault);
      const map = new Map((vault.list||[]).map(c=>[c.phone, c]));
      let added=0, skipped=0;
      obj.list.forEach(c=>{
		  if (!c || !c.phone || !c.name) return; // Validation
		  if(!map.has(c.phone)){ map.set(c.phone, c); added++; } else { skipped++; }
	  });
      vault.list = Array.from(map.values());
      st.vault = await encryptJson(S.getKey(), vault); S.save(st);
      refreshContactsSelect(vault.list);
      showToast(`Importación completa. Añadidos: ${added}, existentes: ${skipped}.`, 'success');
      if(getAutoBackup()) exportFixedBackup(true);
	  triggerAutoFsaBackup();
    }
    async function exportCSV(){
      if(!S.getKey()){ showToast('Inicia sesión para exportar.', 'error'); return; }
      const vault=await decryptJson(S.getKey(), S.state().vault);
      const csv = [['nombre','telefono'], ...(vault.list||[]).map(c=>[c.name, c.phone])].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      saveCsv('contactos.csv', csv);
    }
    function getAutoBackup(){ return !!S.state()?.autoBackup; }
    function setAutoBackup(v){ const st=S.state(); if(!st) return; st.autoBackup = !!v; S.save(st); $('autoBackupToggle').checked = st.autoBackup; }

	// ===== BACKUPS (AGENDA) =====
	let pendingAutoCalBackup = null;
	function showAutoCalToast(show){ $('autoCalBackupToast').style.display = show ? 'block' : 'none'; }
	async function exportAgendaFixed(auto=false){
	  const st=S.state(); if(!st || !S.getKey()){ if(!auto) showToast('Inicia sesión para exportar.', 'error'); return; }
	  const vault=await decryptJson(S.getKey(), st.vault);
	  const {aesKey, saltB64} = await deriveFixed();
	  const pack = await encryptJson(aesKey, { events: (vault.events||[]) });
	  const payload = { format:'mf-agenda-fixed-v1', saltB64, iv: pack.iv, ct: pack.ct, createdAt: new Date().toISOString() };
	  const name = auto ? ('autobackup-agenda-' + new Date().toISOString().replace(/[-:T.Z]/g,'').slice(0,14) + '.json') : 'copia-agenda.json';
	  if (auto) { pendingAutoCalBackup = { name, json: JSON.stringify(payload, null, 2) }; showAutoCalToast(true); }
	  else { await saveJson(name, payload); showToast('Copia de agenda exportada.', 'success'); }
	}
	async function importAgendaFixedFromFile(file){
	  let data; try{ data=JSON.parse(await file.text()); }catch(_){ showToast('Archivo no válido.', 'error'); return; }
	  if(data.format!=='mf-agenda-fixed-v1'){ showToast('Copia de agenda no reconocida.', 'error'); return; }
	  let obj; try{ const {aesKey} = await deriveFixed(data.saltB64); obj = await decryptJson(aesKey, {iv:data.iv, ct:data.ct}); } catch(e){ showToast('No se pudo descifrar.', 'error'); return; }
	  if(!obj || !Array.isArray(obj.events)){ showToast('Contenido inválido.', 'error'); return; }
	  const st=S.state(); if(!st || !S.getKey()){ showToast('Inicia sesión para importar.', 'error'); return; }
	  const vault=await decryptJson(S.getKey(), st.vault); ensureEvents(vault);
	  const byId = new Map((vault.events||[]).map(e=>[e.id, e]));
	  let added=0, skipped=0;
	  (obj.events||[]).forEach(e=>{
		if(!e || !e.id || !e.start) return; // Validation
		if(byId.has(e.id)) skipped++; else { byId.set(e.id, e); added++; }
	  });
	  vault.events = Array.from(byId.values()).sort((a,b)=> new Date(a.start)-new Date(b.start));
	  st.vault = await encryptJson(S.getKey(), vault); S.save(st);
	  paintEventDots(); renderDayList();
	  showToast(`Agenda importada. Añadidos: ${added}, existentes: ${skipped}.`, 'success');
	  if(getAutoBackupCal()) exportAgendaFixed(true);
	  triggerAutoFsaBackup();
	}
	function getAutoBackupCal(){ return !!S.state()?.autoBackupCal; }
	function setAutoBackupCal(v){ const st=S.state(); if(!st) return; st.autoBackupCal = !!v; S.save(st); $('autoBackupCalToggle').checked = st.autoBackupCal; }

	// ===== BACKUPS (FULL) =====
	async function exportFullFixed(){
	  const st = S.state(); if(!st || !S.getKey()){ showToast('Inicia sesión para exportar.', 'error'); return; }
	  const vault = await decryptJson(S.getKey(), st.vault);
	  const {aesKey, saltB64} = await deriveFixed();
	  const pack = await encryptJson(aesKey, { list: (vault.list||[]), events: (vault.events||[]), templates: (vault.templates||[]) });
	  const payload = { format:'mf-full-fixed-v1', saltB64, iv: pack.iv, ct: pack.ct, createdAt: new Date().toISOString() };
	  await saveJson('copia-completa.json', payload);
	  showToast('Copia completa exportada.', 'success');
	}
	async function importFullFixedFromFile(file){
	  let data; try{ data = JSON.parse(await file.text()); }catch(_){ showToast('Archivo no válido', 'error'); return; }
	  if(data.format!=='mf-full-fixed-v1'){ showToast('Copia completa no reconocida.', 'error'); return; }
	  let obj; try{ const {aesKey} = await deriveFixed(data.saltB64); obj = await decryptJson(aesKey, {iv:data.iv, ct:data.ct}); } catch(e){ showToast('No se pudo descifrar.', 'error'); return; }
	  if(!obj || !Array.isArray(obj.list) || !Array.isArray(obj.events)){ showToast('Contenido inválido.', 'error'); return; }
	  const st = S.state(); if(!st || !S.getKey()){ showToast('Inicia sesión para importar.', 'error'); return; }
	  const vault = await decryptJson(S.getKey(), st.vault);
      ensureEvents(vault);
      if (!vault.templates) vault.templates = [];

	  const mapContacts = new Map((vault.list||[]).map(c=>[c.phone, c])); let addedC=0, skippedC=0;
	  (obj.list||[]).forEach(c=>{ if(c&&c.phone&&c.name){ if(mapContacts.has(c.phone)) skippedC++; else { mapContacts.set(c.phone, c); addedC++; } } });
	  vault.list = Array.from(mapContacts.values());

	  const mapEvents = new Map((vault.events||[]).map(e=>[e.id, e])); let addedE=0, skippedE=0;
	  (obj.events||[]).forEach(e=>{ if(e&&e.id&&e.start){ if(mapEvents.has(e.id)) skippedE++; else { mapEvents.set(e.id, e); addedE++; } } });
	  vault.events = Array.from(mapEvents.values()).sort((a,b)=> new Date(a.start)-new Date(b.start));

      const mapTemplates = new Map((vault.templates||[]).map(t=>[t.id, t])); let addedT=0, skippedT=0;
	  (obj.templates||[]).forEach(t=>{ if(t&&t.id&&t.name&&t.content){ if(mapTemplates.has(t.id)) skippedT++; else { mapTemplates.set(t.id, t); addedT++; } } });
	  vault.templates = Array.from(mapTemplates.values());

	  st.vault = await encryptJson(S.getKey(), vault); S.save(st);
	  refreshContactsSelect(vault.list);
      paintEventDots();
      renderDayList();
      renderTemplates();
      populateTemplateSelectors();
	  showToast(`Importación completa. Contactos: ${addedC}+, Citas: ${addedE}+, Plantillas: ${addedT}+`, 'success');
	}
	
	async function processFullBackupData(data) {
		if(data.format!=='mf-full-fixed-v1'){ showToast('Copia completa no reconocida.', 'error'); return false; }
		let obj;
		try {
			const {aesKey} = await deriveFixed(data.saltB64);
			obj = await decryptJson(aesKey, {iv:data.iv, ct:data.ct});
		} catch(e){ showToast('No se pudo descifrar la copia.', 'error'); return false; }
		if(!obj || !Array.isArray(obj.list) || !Array.isArray(obj.events)){ showToast('El contenido de la copia es inválido.', 'error'); return false; }
		const freshVault = { list: obj.list || [], events: obj.events || [], templates: obj.templates || [] };
		let pass = prompt("Crea una nueva contraseña para tus datos restaurados (mín. 6 caracteres)");
		if (!pass || pass.length < 6) { showToast("La contraseña no es válida.", "error"); return false; }
		let user = prompt("Crea un nuevo nombre de usuario");
		if (!user) { showToast("Se requiere un nombre de usuario.", "error"); return false; }
		const {aesKey, pwHashB64, saltB64} = await derive(pass);
		S.setKey(aesKey);
		S.setUser(user);
		const pack = await encryptJson(aesKey, freshVault);
		S.save({user, pwHashB64, saltB64, vault:pack, autoBackup:false});
		triggerAutoBackup();
		showToast(`Restauración completa. Por favor, inicia sesión con tus nuevas credenciales.`, 'success');
		return true;
	}

	async function importFullFixedFromContent(content) {
		try {
			const data = JSON.parse(content);
			return await processFullBackupData(data);
		} catch (e) { showToast('El archivo de copia de seguridad está dañado.', 'error'); return false; }
	}

	async function importFullFixedFromFile(file){
	  try {
		const content = await file.text();
		const success = await importFullFixedFromContent(content);
		if (success) { show('loginView'); }
	  } catch(e) { showToast('No se pudo leer el archivo.', 'error'); }
	}
	
	// ===== FILE SYSTEM ACCESS API & AUTO-BACKUP =====
	const fsaSupported = 'showDirectoryPicker' in window;
	const FsaBackupFile = 'backup_mf_gestor_citas.json';

	async function updateAutoBackupStatus() {
		const statusEl = $('autoBackupStatus');
		const btn = $('btnAutoBackupSetup');
		const container = $('autoBackupContainer');
		if(!container) return;

		container.style.display = 'block';

		if (fsaSupported) {
			const dirHandle = await idbKeyval.get('backupDirHandle');
			if (dirHandle) {
				if (await dirHandle.queryPermission({ mode: 'readwrite' }) === 'granted') {
					statusEl.textContent = `Guardando en la carpeta: "${dirHandle.name}".`;
					btn.textContent = 'Cambiar Carpeta';
				} else {
					statusEl.textContent = 'Permiso denegado. Vuelve a activar.';
					btn.textContent = 'Activar Guardado en Dispositivo';
					await idbKeyval.del('backupDirHandle');
				}
			} else {
				statusEl.textContent = 'Recomendado. Guarda una copia segura en una carpeta de tu dispositivo.';
				btn.textContent = 'Activar Guardado en Dispositivo';
			}
		} else {
			const idbEnabled = await idbKeyval.get('idbBackupEnabled');
			if (idbEnabled) {
				statusEl.textContent = 'Guardado interno activado en este navegador.';
				btn.textContent = 'Desactivar Guardado Interno';
			} else {
				statusEl.textContent = 'Recomendado. Protege tus datos contra cierres accidentales.';
				btn.textContent = 'Activar Guardado Interno';
			}
		}
	}
	
	async function triggerAutoFsaBackup() {
		if (!fsaSupported || !S.getKey()) return;
		const dirHandle = await idbKeyval.get('backupDirHandle');
		if (!dirHandle) return;
		try {
			if (await dirHandle.queryPermission({ mode: 'readwrite' }) !== 'granted') { updateAutoBackupStatus(); return; }
			const vault = await decryptJson(S.getKey(), S.state().vault);
			const {aesKey, saltB64} = await deriveFixed();
			const pack = await encryptJson(aesKey, { list: (vault.list||[]), events: (vault.events||[]), templates: (vault.templates||[]) });
			const payload = { format:'mf-full-fixed-v1', saltB64, iv: pack.iv, ct: pack.ct, createdAt: new Date().toISOString() };
			const fileHandle = await dirHandle.getFileHandle(FsaBackupFile, { create: true });
			const writable = await fileHandle.createWritable();
			await writable.write(JSON.stringify(payload));
			await writable.close();
			console.log('Copia de seguridad automática (FSA) guardada con éxito.');
		} catch (error) {
			console.error('Error durante el auto-backup de FSA:', error);
			showToast('Error al guardar la copia automática.', 'error');
			updateAutoBackupStatus();
		}
	}
	
	async function triggerAutoIdbBackup() {
		if (!S.getKey()) return;
		const idbEnabled = await idbKeyval.get('idbBackupEnabled');
		if (!idbEnabled) return;
		try {
			const vault = await decryptJson(S.getKey(), S.state().vault);
			const {aesKey, saltB64} = await deriveFixed();
			const pack = await encryptJson(aesKey, { list: (vault.list||[]), events: (vault.events||[]), templates: (vault.templates||[]) });
			const payload = { format:'mf-full-fixed-v1', saltB64, iv: pack.iv, ct: pack.ct, createdAt: new Date().toISOString() };
			await idbKeyval.set('idbBackupContent', JSON.stringify(payload));
			console.log('Copia de seguridad interna (IDB) guardada con éxito.');
		} catch (error) {
			console.error('Error durante el auto-backup de IndexedDB:', error);
			showToast('Error al guardar la copia interna.', 'error');
		}
	}

	async function triggerAutoBackup() {
		if (fsaSupported) {
			await triggerAutoFsaBackup();
		} else {
			await triggerAutoIdbBackup();
		}
	}

	// ===== PASSWORD VISIBILITY =====
    const eyeOpen = `<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5c-5.5 0-10 4.5-11 7 1 2.5 5.5 7 11 7s10-4.5 11-7c-1-2.5-5.5-7-11-7Z"></path><circle cx="12" cy="12" r="3.5" fill="currentColor" stroke="none"></circle></g>`;
    const eyeOff = `<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5c-5.5 0-10 4.5-11 7 1 2.5 5.5 7 11 7s10-4.5 11-7c-1-2.5-5.5-7-11-7Z"></path><circle cx="12" cy="12" r="3.5" fill="currentColor" stroke="none"></circle><path d="M3 3L21 21"></path></g>`;
    function setEyeIcon(el, visible){ if(el) el.innerHTML = visible ? eyeOff : eyeOpen; }

    // ===== CALENDAR LOGIC =====
    let currentView = 'month'; // 'month' or 'week'
	let currentWeekDate = new Date();
	const WEEKLY_VIEW_START_HOUR = 7;
	const WEEKLY_VIEW_END_HOUR = 22;

    const toLocalInput = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
    const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; }
    const isSameDay = (a,b) => startOfDay(a).getTime()===startOfDay(b).getTime();
    const addDays = (d, k) => { const x=new Date(d); x.setDate(x.getDate()+k); return x; }
    const firstDayGrid = (d) => {
      const x=new Date(d.getFullYear(), d.getMonth(), 1); const day=(x.getDay()+6)%7; return addDays(x, -day);
    };
    let currentMonth = new Date(), selectedDay = new Date();
    function ensureEvents(vault){ if(!vault.events) vault.events = []; return vault; }

    function getStartOfWeek(d) {
		const date = new Date(d);
		const day = date.getDay();
		const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Lunes como primer día
		return startOfDay(new Date(date.setDate(diff)));
	}

	async function propagateContactEdit(oldPhone, newPhone, newName){
	  const st = S.state(); if(!st || !S.getKey()) return false;
	  const vault = await decryptJson(S.getKey(), st.vault); ensureEvents(vault);
	  let touched = false;
	  (vault.events || []).forEach(e=>{ if (e && e.contactPhone === oldPhone){ e.contactPhone = newPhone; if (newName) e.contactName = newName; touched = true; } });
	  if (touched){
          st.vault = await encryptJson(S.getKey(), vault); S.save(st);
          if (currentView === 'month') { renderCalendar() } else { renderWeeklyCalendar() };
      }
	  const evtSel = $('evtContact');
	  if (evtSel) for (let o of evtSel.options) if (o.value === oldPhone) { o.value = newPhone; o.text = `${newName} (${newPhone})`; }
	  [ 'evtSearch', 'contactSearch' ].forEach(id => { const el = $(id); if (el && el.value.includes(oldPhone)) el.value = `${newName} (${newPhone})`; });
	  updateSelectedContactCard(newPhone);
	  return touched;
	}
    function monthLabel(date){ return date.toLocaleDateString(undefined, {month:'long', year:'numeric'}); }
    function weekLabel(date) {
        const start = getStartOfWeek(date);
        const end = addDays(start, 6);
        const startMonth = start.toLocaleDateString(undefined, {month: 'long'});
        const endMonth = end.toLocaleDateString(undefined, {month: 'long'});

        if (startMonth === endMonth) {
            return `${start.getDate()} - ${end.getDate()} de ${endMonth}, ${end.getFullYear()}`;
        }
        return `${start.getDate()} de ${startMonth} - ${end.getDate()} de ${endMonth}, ${end.getFullYear()}`;
    }

    function highlightSelected(dateKey){
      const key = dateKey || selectedDay.toISOString().slice(0,10);
      document.querySelectorAll('.cal-cell.cal-selected').forEach(el=>el.classList.remove('cal-selected'));
      document.querySelector(`.cal-cell[data-date="${key}"]`)?.classList.add('cal-selected');
    }
    function renderCalendar(){
      const grid=$('calGrid'); if(!grid) return;
      grid.innerHTML=''; $('calTitle').textContent = `${monthLabel(currentMonth)}`;
      ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'].forEach(d=>{ const el=document.createElement('div'); el.className='cal-dow'; el.textContent=d; grid.appendChild(el); });
      const start = firstDayGrid(currentMonth), today = new Date();
      for(let i=0;i<42;i++){
        const day = addDays(start, i), cell=document.createElement('div');
        cell.className='cal-cell'; cell.dataset.date = day.toISOString().slice(0,10);
        if(day.getMonth()!==currentMonth.getMonth()) cell.classList.add('cal-other');
        if(isSameDay(day,today)) cell.classList.add('cal-today');
        cell.innerHTML = `<div class="cal-num">${day.getDate()}</div><div class="dots" data-date="${day.toISOString()}"></div>`;
        cell.onclick = ()=>{ selectedDay = day; renderDayList(); highlightSelected(cell.dataset.date); };
        grid.appendChild(cell);
      }
      paintEventDots(); highlightSelected(); renderDayList();
    }
    async function paintEventDots(){
	  const st=S.state(); if(!st || !S.getKey()) return;
	  const v = await decryptJson(S.getKey(), st.vault); ensureEvents(v);
	  document.querySelectorAll('.dots').forEach(n=>{
		  const day = new Date(n.dataset.date);
		  const events = v.events.filter(e=> isSameDay(day, new Date(e.start)) );
		  n.innerHTML='';
		  events.slice(0,4).forEach((evt,idx)=>{ n.innerHTML += `<span class="dot ${['green','yellow','red',''][idx]||''}"></span>`; });
	  });
	}
    async function renderDayList(){
      const st=S.state(), list=$('dayList'), head=$('dayTitle'); if(!st || !S.getKey() || !list || !head) return;
      head.textContent = selectedDay.toLocaleDateString(undefined,{weekday:'long', day:'2-digit', month:'long', year:'numeric'});
      head.classList.remove('flash'); void head.offsetWidth; head.classList.add('flash');
      const v = await decryptJson(S.getKey(), st.vault); ensureEvents(v);
      const evts = v.events.filter(e=> isSameDay(selectedDay, new Date(e.start)) ).sort((a,b)=> new Date(a.start)-new Date(b.start));
      list.innerHTML = !evts.length ? `<div class="muted">Sin citas en este día.</div>` : evts.map((evt, idx) => `
		<div class="evt-item">
			<div>${esc(evt.title||'Cita')}</div>
			<div class="muted">${new Date(evt.start).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}${evt.contactName?` · ${esc(evt.contactName)}`:''}</div>
			<div class="evt-actions" style="margin-top:10px">
				<button class="btn-small btn-outline" onclick="openEventModalById('${evt.id}')">Editar</button>
				<button class="btn-small btn-outline" onclick="sendEventByWhatsAppById('${evt.id}')">Enviar</button>
				<button class="btn-small btn-danger" onclick="deleteEvent('${evt.id}')">Eliminar</button>
			</div>
		</div>
		${idx < evts.length - 1 ? '<div class="evt-sep"></div>' : ''}
	  `).join('');
    }

    async function renderWeeklyCalendar() {
		const grid = $('calGridWeekly');
		if (!grid) return;
		
        $('calTitle').textContent = weekLabel(currentWeekDate);
		const st = S.state();
		if (!st || !S.getKey()) return;
		const vault = await decryptJson(S.getKey(), st.vault);

		grid.innerHTML = ''; 

		const weekStart = getStartOfWeek(currentWeekDate);
		const today = new Date();

        // 1. Cabecera con días de la semana
		const timeHeader = document.createElement('div');
        timeHeader.className = 'cal-weekly-header cal-weekly-header-time';
        grid.appendChild(timeHeader);
		for (let i = 0; i < 7; i++) {
			const day = addDays(weekStart, i);
			const headerCell = document.createElement('div');
			headerCell.className = 'cal-weekly-header';
			if (isSameDay(day, today)) headerCell.classList.add('is-today');
			headerCell.innerHTML = `${day.toLocaleDateString(undefined, { weekday: 'short' }).slice(0,3)}<br><span style="font-size: 1.2em;">${day.getDate()}</span>`;
			grid.appendChild(headerCell);
		}

        // 2. Columna de horas
		const timeCol = document.createElement('div');
		timeCol.className = 'cal-weekly-times';
		for (let hour = WEEKLY_VIEW_START_HOUR; hour < WEEKLY_VIEW_END_HOUR; hour++) {
			const slot1 = document.createElement('div');
			slot1.className = 'cal-weekly-time-slot';
			slot1.textContent = `${String(hour).padStart(2, '0')}:00`;
			const slot2 = document.createElement('div'); // For the :30 slot line
			slot2.className = 'cal-weekly-time-slot';
			timeCol.appendChild(slot1);
			timeCol.appendChild(slot2);
		}
		grid.appendChild(timeCol);

        // 3. Contenedor para eventos y las columnas de día
        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            const day = addDays(weekStart, i);
            dayCol.className = 'cal-weekly-day-col';
            if (isSameDay(day, today)) dayCol.classList.add('is-today-col');

            const weekEnd = addDays(weekStart, 7);
            const dayEvents = (vault.events || []).filter(e => {
                const eventDate = new Date(e.start);
                return isSameDay(eventDate, day) && eventDate >= startOfDay(weekStart) && eventDate < startOfDay(weekEnd);
            });

            dayEvents.forEach(evt => {
                const eventEl = document.createElement('div');
                eventEl.className = 'cal-weekly-event';
                eventEl.onclick = () => openEventModalById(evt.id);
                
                const start = new Date(evt.start);
                const end = evt.end ? new Date(evt.end) : new Date(start.getTime() + 60 * 60 * 1000);
                
                const startMinutes = (start.getHours() * 60 + start.getMinutes()) - (WEEKLY_VIEW_START_HOUR * 60);
                const endMinutes = (end.getHours() * 60 + end.getMinutes()) - (WEEKLY_VIEW_START_HOUR * 60);
                const durationMinutes = Math.max(30, endMinutes - startMinutes);

                eventEl.style.top = `${(startMinutes / 30) * 40}px`; 
                eventEl.style.height = `${(durationMinutes / 30) * 40}px`;

                eventEl.innerHTML = `
                    <div class="evt-weekly-title">${esc(evt.title || 'Cita')}</div>
                    <div class="evt-weekly-meta">${start.toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'})}</div>
                `;
                dayCol.appendChild(eventEl);
            });
            grid.appendChild(dayCol);
        }
	}
    
    async function openEventModalById(id) {
        const vault = await decryptJson(S.getKey(), S.state().vault);
        const evt = vault.events.find(e => e.id === id);
        if (evt) openEventModal(evt);
    }
    function openEventModal(evt){
      const dlg=$('eventModal');
      const title=$('evtModalTitle'), del=$('evtDelete');
      if(!evt){
        title.textContent='Nueva cita';
        const base=new Date(selectedDay); base.setHours(10,0,0,0);
		$('evtForm').reset();
        $('evtId').value = '';
		$('evtContact').value = '';
        $('evtStart').value = toLocalInput(base);
        del.style.display='none';
      }else{
        title.textContent='Editar cita';
        $('evtId').value = evt.id;
        $('evtTitle').value=evt.title||'';
        $('evtStart').value = toLocalInput(new Date(evt.start));
        $('evtEnd').value = evt.end ? toLocalInput(new Date(evt.end)) : '';
        $('evtContact').value = evt.contactPhone || '';
        $('evtNote').value=evt.note||'';
		$('evtRecurrence').value = evt.recurrence || 'none';
        del.style.display='inline-flex';
      }
      const sbox = $('evtSearch'), c = findContactByPhone(evt?.contactPhone);
      sbox.value = c ? `${c.name} (${c.phone})` : '';
      $('evtResults').hidden = true;
      dlg.showModal();
    }
    function closeEventModal(){ $('eventModal')?.close(); }
    function makeId(){ return 'evt_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
    async function saveEvent() {
		const btn = $('evtSave');
		toggleLoading(btn, true);

		try {
			const t = $('evtTitle').value.trim(), s = $('evtStart').value, e = $('evtEnd').value;
			for(let id of ['evtStart-field', 'evtEnd-field']) $(id).classList.remove('field-error');
			if (!s) { throw new Error('Indica fecha y hora de inicio'); }
			if (e && new Date(e) < new Date(s)) { throw new Error('La fecha de fin no puede ser anterior a la de inicio.'); }

			const st = S.state(); if (!st || !S.getKey()) throw new Error("Sesión no válida");
			let vault = await decryptJson(S.getKey(), st.vault);
			ensureEvents(vault);

			const id = $('evtId').value;
			const isNew = !id;
			const prevEvent = isNew ? null : vault.events.find(x => x.id === id);
			const contact = findContactByPhone($('evtContact').value || '') || {};

			const eventData = {
				id: id || makeId(), title: t, start: new Date(s).toISOString(),
				end: e ? new Date(e).toISOString() : null, contactPhone: contact.phone || null,
				contactName: contact.name || null, note: $('evtNote').value.trim() || null,
				recurrence: $('evtRecurrence').value, gcalId: prevEvent?.gcalId || null
			};

			if (isNew) { vault.events.push(eventData); }
            else { const idx = vault.events.findIndex(x => x.id === id); if (idx >= 0) vault.events[idx] = eventData; }

            st.vault = await encryptJson(S.getKey(), vault);
			S.save(st);
			showToast(isNew ? 'Cita creada.' : 'Cita guardada.', 'success', 3000, 'modal');
			triggerAutoFsaBackup();

			if (getGCalAuto()) {
				const newGCalId = await addEventToGoogle(eventData);
				if (newGCalId && eventData.gcalId !== newGCalId) {
					eventData.gcalId = newGCalId;
                    const freshVault = await decryptJson(S.getKey(), S.state().vault);
                    const idx = freshVault.events.findIndex(x => x.id === eventData.id);
                    if (idx !== -1) freshVault.events[idx].gcalId = newGCalId;
					const finalPack = await encryptJson(S.getKey(), freshVault);
                    S.save({ ...S.state(), vault: finalPack });
					console.log(`gcalId ${newGCalId} guardado para el evento local ${eventData.id}`);
				}
			}

			closeEventModal();
			if(currentView === 'month') { renderCalendar(); } else { await renderWeeklyCalendar(); }
            if(currentView === 'month') renderDayList();
			if (getAutoBackupCal()) exportAgendaFixed(true);

		} catch (error) {
			console.error("Error al guardar el evento:", error);
			showToast(error.message || 'Ocurrió un error al guardar.', 'error', 3000, 'modal');
            if(error.message.includes('inicio')) $('evtStart-field').classList.add('field-error');
            if(error.message.includes('fin')) $('evtEnd-field').classList.add('field-error');
		} finally {
			toggleLoading(btn, false);
		}
	}
    async function deleteEvent(id){
      if(!await showConfirmation('Eliminar Cita', '¿Seguro que quieres eliminar esta cita?')) return;
	  const st=S.state(); if(!st||!S.getKey()) return;
	  const vault=ensureEvents(await decryptJson(S.getKey(), st.vault));
	  const eventToDelete = (vault.events || []).find(e => e.id === id);

	  if (!eventToDelete) {
		showToast('Error: No se encontró la cita a eliminar.', 'error', 3000, 'modal');
		return;
	  }

	  if (eventToDelete.gcalId && getGCalAuto()){
		await deleteEventFromGoogle(eventToDelete.gcalId);
	  }

	  vault.events = (vault.events || []).filter(e => e.id !== id);
	  st.vault=await encryptJson(S.getKey(), vault); S.save(st);
	  triggerAutoFsaBackup();
      
      showToast('Cita eliminada.', 'success'); // This will show globally after modal closes
	  try { closeEventModal(); } catch(_) {}
	  if(currentView === 'month') { renderCalendar(); } else { await renderWeeklyCalendar(); }

	  if (getAutoBackupCal()) exportAgendaFixed(true);
    }
    async function sendEventByWhatsAppById(id) {
        const vault = await decryptJson(S.getKey(), S.state().vault);
        const evt = vault.events.find(e => e.id === id);
        if (evt) sendEventByWhatsApp(evt);
    }
    function sendEventByWhatsApp(evt){
	  console.log("Intentando enviar cita:", evt);
      if(!evt || !evt.contactPhone || !isPhoneValid(evt.contactPhone)){ 
		  showToast('La cita no tiene un contacto válido para enviar.', 'error'); 
		  return; 
	  }
      openExternal(`https://wa.me/${evt.contactPhone.replace('+','')}/?text=${encodeURIComponent(buildEventMessage(evt))}`);
    }

    // ===== MODAL SEARCH LOGIC =====
    let activeIndexEvt = -1;
    function selectModalContact(c){
      $('evtContact').value = c.phone;
      $('evtSearch').value = `${c.name} (${c.phone})`;
      $('evtResults').hidden = true; activeIndexEvt = -1;
    }
    function setActiveEvt(idx){
      const items=[...$('evtResults').querySelectorAll('.result-item')];
      items.forEach(el=>el.setAttribute('aria-selected','false'));
      activeIndexEvt = Math.max(0, Math.min(idx, items.length-1));
      const el = items[activeIndexEvt]; if(el){ el.setAttribute('aria-selected','true'); el.scrollIntoView({block:'nearest'}); }
    }
    function chooseActiveEvt(){
      const el = $('evtResults').querySelector('.result-item[aria-selected="true"]');
      if(el){ const c = (window.__contacts||[]).find(x=>x.phone===el.dataset.phone); if(c) selectModalContact(c); }
    }
    function renderEvtResults(query){
      const box = $('evtResults'), q = (query||'').trim(); $('evtClear').style.display = q ? 'block' : 'none';
      const items = (window.__contacts||[]).map(c => ({ c, s: scoreContact(q, c) })).filter(o => o.s > -Infinity).sort((a,b)=>b.s - a.s).slice(0,60);
      box.innerHTML = ''; activeIndexEvt = -1;
      if(!q){ box.hidden = true; return; }
      if(!items.length){ box.hidden=false; box.innerHTML=`<div class='muted' style='padding:10px;'>Sin resultados</div>`; return; }
      items.forEach((o, idx)=>{
        const btn=document.createElement('button'); btn.type='button'; btn.className='result-item'; btn.setAttribute('role','option');
        btn.dataset.phone=o.c.phone; btn.innerHTML = `<span class="result-name">${highlight(o.c.name, q)}</span> <span class="result-phone">${highlight(o.c.phone, q)}</span>`;
        btn.onclick = ()=>selectModalContact(o.c); btn.onmousemove = ()=>setActiveEvt(idx);
        box.appendChild(btn);
      });
      box.hidden = false;
    }
    function wireModalSearch(){
      const input=$('evtSearch'), box=$('evtResults'), clear=$('evtClear');
      
      input.addEventListener('input', debounce(() => {
        const query = input.value;
        renderEvtResults(query);
        // CORRECCIÓN: Si el usuario vacía el campo, limpiar el contacto seleccionado.
        if (query.trim() === '') {
            $('evtContact').value = '';
        }
      }, 200));

      input.addEventListener('focus', ()=>renderEvtResults(input.value));
      input.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowDown'){ e.preventDefault(); setActiveEvt(activeIndexEvt<0?0:activeIndexEvt+1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); setActiveEvt(activeIndexEvt<=0?0:activeIndexEvt-1); }
        else if(e.key==='Enter' && !box.hidden){ e.preventDefault(); chooseActiveEvt(); }
        else if(e.key==='Escape'){ box.hidden=true; activeIndexEvt=-1; }
      });
      clear?.addEventListener('click', ()=>{ 
          input.value=''; 
          $('evtContact').value = ''; // CORRECCIÓN: Limpiar también el contacto seleccionado
          box.hidden=true; 
          input.focus(); 
          renderEvtResults(''); 
      });
    }

	// ===== GOOGLE CALENDAR =====
	const GOOGLE_CLIENT_ID = '725040297865-tftgfffsebmoejifco1siqf67m7n9d9d.apps.googleusercontent.com';
	const GCAL_SCOPE = 'https://www.googleapis.com/auth/calendar.events';
	let googleTokenClient = null, googleAccessToken = null, googleTokenExpiry = 0;

	function setGStatus(connected){ $('gStatus').textContent = connected ? 'Conectado' : 'Sin conectar'; $('gCalAutoToggle').disabled = !connected; $('btnGConnect').textContent = connected ? 'Reconectar' : 'Conectar Google'; }
	function getGCalAuto(){ return !!S.state()?.gcalAuto; }
	function setGCalAuto(v){ const st=S.state(); if(!st) return; st.gcalAuto = !!v; S.save(st); $('gCalAutoToggle').checked = st.gcalAuto; }
	function setupGoogle(){ if (!window.google) return; googleTokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GCAL_SCOPE, callback: (resp)=>{ if(resp.access_token){ googleAccessToken=resp.access_token; googleTokenExpiry=Date.now()+(resp.expires_in||3600)*1000; setGStatus(true); } } }); setGStatus(false); if(getGCalAuto()) try { googleTokenClient.requestAccessToken({ prompt: '' }); } catch(_) {} }

	async function ensureGoogleToken(silent=true){
	  if (googleAccessToken && Date.now() < googleTokenExpiry - 60_000) return googleAccessToken;
	  if (!googleTokenClient) throw new Error('Google no inicializado');
	  return new Promise((resolve,reject)=>{
		googleTokenClient.callback = (resp)=>{
		  if (resp && resp.access_token){
			googleAccessToken = resp.access_token;
			googleTokenExpiry = Date.now() + (resp.expires_in||3600)*1000;
			setGStatus(true);
			resolve(googleAccessToken);
		  } else {
            setGStatus(false);
            reject(new Error('No se pudo obtener el token de Google.'));
          }
		};
		try {
		  googleTokenClient.requestAccessToken({ prompt: silent ? '' : 'consent' });
		} catch(e){
		  reject(e);
		}
	  });
	}

	async function addEventToGoogle(evt) {
		try {
			const token = await ensureGoogleToken(true);
			const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Madrid';
			const endISO = evt.end || new Date(new Date(evt.start).getTime() + 60 * 60 * 1000).toISOString();

			const payload = {
				summary: evt.title || 'Cita',
				description: evt.note || '',
				start: { dateTime: evt.start, timeZone: tz },
				end: { dateTime: endISO, timeZone: tz }
			};

			const base = 'https://www.googleapis.com/calendar/v3/calendars/primary/events';
			let url = base;
			let method = 'POST';
			if (evt.gcalId) {
				url = `${base}/${encodeURIComponent(evt.gcalId)}`;
				method = 'PATCH';
			}

			let r = await fetch(url, {
				method,
				headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});

			if (r.status === 401) {
				googleAccessToken = null;
				const token2 = await ensureGoogleToken(false);
				r = await fetch(url, { method, headers: { 'Authorization': 'Bearer ' + token2, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
			}

			if (!r.ok && method === 'PATCH' && r.status === 404) {
                console.log('Evento no encontrado en Google Calendar, creando uno nuevo...');
				const token3 = await ensureGoogleToken(true);
				r = await fetch(base, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token3, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
			}

			if (!r.ok) {
                const errorData = await r.json();
                throw new Error(`Google Calendar error: ${r.status} - ${errorData.error.message}`);
            }
			const j = await r.json();
            
            showToast(method === 'POST' ? 'Cita creada en Google Calendar.' : 'Cita actualizada en Google Calendar.', 'success', 3000, 'modal');
			return j.id;

		} catch (e) {
			console.warn('No se pudo sincronizar con Google Calendar:', e);
            showToast('Error al sincronizar con Google.', 'error', 3000, 'modal');
			return null;
		}
	}


	async function deleteEventFromGoogle(gcalId) {
	  if (!gcalId) return true;
	  try {
		const base = 'https://www.googleapis.com/calendar/v3/calendars/primary/events/';
		const url = base + encodeURIComponent(gcalId);

		let token = await ensureGoogleToken(true);
		let r = await fetch(url, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });

		if (r.status === 401) {
		  googleAccessToken = null;
		  token = await ensureGoogleToken(false);
		  r = await fetch(url, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
		}

		if (!r.ok && ![404, 410].includes(r.status)) {
		  throw new Error('Google Calendar delete error: ' + r.status);
		}

		console.log('Evento eliminado de Google Calendar con éxito.');
        showToast('Cita eliminada de Google Calendar.', 'info');
		return true;

	  } catch (e) {
		console.warn('No se pudo borrar el evento en Google Calendar:', e);
        showToast('No se pudo eliminar la cita de Google.', 'error');
		return false;
	  }
	}

    // ===== TEMPLATES =====
    function makeTemplateId(){ return 'tpl_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
	async function renderTemplates() {
		const list = $('templateList'); if (!list) return;
		const st = S.state(); if (!st || !S.getKey()) return;
		const vault = await decryptJson(S.getKey(), st.vault);
		const templates = vault.templates || [];
		if (templates.length === 0) {
			list.innerHTML = `<p class="muted" style="text-align:center;">Aún no has creado ninguna plantilla.</p>`;
			return;
		}
		list.innerHTML = templates.map(tpl => `
			<div class="template-card" data-id="${tpl.id}">
				<div class="template-header">
					<div class="template-name">${esc(tpl.name)}</div>
					<div class="contact-actions">
						<button class="btn-small btn-outline" onclick="editTemplate('${tpl.id}')">Editar</button>
						<button class="btn-small btn-danger" onclick="deleteTemplate('${tpl.id}')">Eliminar</button>
					</div>
				</div>
				<div class="template-content">${esc(tpl.content)}</div>
			</div>
		`).join('');
	}
	async function saveTemplate() {
		const id = $('templateId').value;
		const name = $('templateName').value.trim();
		const content = $('templateContent').value.trim();
		if (!name || !content) { showToast('El nombre y el contenido no pueden estar vacíos.', 'error'); return; }

		const st = S.state(); if (!st || !S.getKey()) return;
		const vault = await decryptJson(S.getKey(), st.vault);
		if (!vault.templates) vault.templates = [];

		if (id) {
			const index = vault.templates.findIndex(t => t.id === id);
			if (index > -1) vault.templates[index] = { id, name, content };
		} else {
			vault.templates.push({ id: makeTemplateId(), name, content });
		}
		st.vault = await encryptJson(S.getKey(), vault); S.save(st);
		triggerAutoFsaBackup();
		showToast(id ? 'Plantilla actualizada' : 'Plantilla guardada', 'success');
		resetTemplateForm(); await renderTemplates(); await populateTemplateSelectors();
	}
	async function deleteTemplate(id) {
		if (!await showConfirmation('Eliminar Plantilla', '¿Seguro que quieres eliminar esta plantilla?')) return;
		const st = S.state(); if (!st || !S.getKey()) return;
		const vault = await decryptJson(S.getKey(), st.vault);
		vault.templates = (vault.templates || []).filter(t => t.id !== id);
		st.vault = await encryptJson(S.getKey(), vault); S.save(st);
		triggerAutoFsaBackup();
		showToast('Plantilla eliminada.', 'success');
		await renderTemplates(); await populateTemplateSelectors();
	}
	async function editTemplate(id) {
		const st = S.state(); if (!st || !S.getKey()) return;
		const vault = await decryptJson(S.getKey(), st.vault);
		const template = (vault.templates || []).find(t => t.id === id);
		if (!template) return;
		$('templateFormTitle').textContent = 'Editando Plantilla';
		$('templateId').value = template.id;
		$('templateName').value = template.name;
		$('templateContent').value = template.content;
		$('btnCancelEditTemplate').style.display = 'inline-flex';
		$('templateName').focus();
	}
	function resetTemplateForm() {
		$('templateFormTitle').textContent = 'Nueva Plantilla';
		$('templateId').value = '';
		$('templateName').value = '';
		$('templateContent').value = '';
		$('btnCancelEditTemplate').style.display = 'none';
	}
	async function populateTemplateSelectors() {
		const st = S.state();
        if (!st || !S.getKey()) {
            [...document.querySelectorAll('select[id^="templateSelect"]')].forEach(sel => sel.innerHTML = '<option value="">No hay plantillas</option>');
            return;
        }
		const vault = await decryptJson(S.getKey(), st.vault);
		const templates = vault.templates || [];
		const selectors = [$('templateSelectSend'), $('templateSelectModal')];
		selectors.forEach((sel, index) => {
			if (!sel) return;
			const currentVal = sel.value;
			sel.innerHTML = `<option value="">${index === 0 ? "Usar plantilla para mensaje..." : "Usar plantilla para notas..."}</option>`;
			templates.forEach(tpl => sel.add(new Option(tpl.name, tpl.id)));
			sel.value = currentVal;
		});
	}
	function applyTemplate(templateContent, contactName = '') {
		return templateContent.replace(/\{NOMBRE\}/g, contactName);
	}

	// ===== EVENT WIRING =====
    function wireEvents(){
      const toggle = (inputId, svgId) => { const i=$(inputId), s=$(svgId); if(!i || !s) return; i.type = i.type==='password'?'text':'password'; setEyeIcon(s, i.type==='text'); };
      setEyeIcon($('toggleLogin'), false); setEyeIcon($('toggleSetup'), false);
      $('toggleLogin')?.addEventListener('click', ()=>toggle('loginPass','toggleLogin'));
      $('toggleSetup')?.addEventListener('click', ()=>toggle('setupPass','toggleSetup'));

      $('btnSetup')?.addEventListener('click', async (e)=>{
        const user=$('setupUser').value.trim(), pass=$('setupPass').value;
        if(!user){ showToast('Introduce un usuario', 'error'); return; }
        if(pass.length<6){ showToast('La contraseña debe tener al menos 6 caracteres', 'error'); return; }
		toggleLoading(e.target, true);
        try{
            const r=await derive(pass);
            S.setKey(r.aesKey); S.setUser(user);
            const pack=await encryptJson(S.getKey(),{list:[], events:[], templates:[]});
            S.save({user, pwHashB64:r.pwHashB64, saltB64:r.saltB64, vault:pack, autoBackup:false});
            refreshContactsSelect([]);
            show('appView');
            setActiveTab('agenda');
            renderCalendar();
        }catch(err){
            console.error(err);
            showToast('Error creando el almacén', 'error');
        }
		toggleLoading(e.target, false, 'Crear y acceder');
      });

      $('btnLogin')?.addEventListener('click', async (e)=>{
        const user=$('loginUser').value.trim(), pass=$('loginPass').value, state=S.state();
        if(!state){ show('setupView'); return; }
        if(user!==state.user){ showToast('Usuario incorrecto', 'error'); return; }
		toggleLoading(e.target, true);
        try{
          const r=await derive(pass, state.saltB64);
          if(r.pwHashB64!==state.pwHashB64){ showToast('Contraseña incorrecta', 'error'); toggleLoading(e.target, false, 'Entrar'); return; }
          const vault=await decryptJson(r.aesKey, state.vault);
          S.setKey(r.aesKey); S.setUser(user); refreshContactsSelect(vault.list);
          show('appView'); setActiveTab('agenda');
		  $('autoBackupToggle').checked = !!state.autoBackup; $('autoBackupCalToggle').checked = !!state.autoBackupCal; $('gCalAutoToggle').checked = !!state.gcalAuto;
          currentMonth = new Date(); selectedDay = new Date(); renderCalendar();
        }catch(err){ showToast('Error al descifrar. Contraseña incorrecta.', 'error'); }
		toggleLoading(e.target, false, 'Entrar');
      });

      $('btnReset')?.addEventListener('click', async ()=>{
        if(await showConfirmation('Borrar Datos', 'Esto borrará TODA la app (usuario, contactos, citas). ¿Continuar?')){
          S.clear(); show('setupView'); window.scrollTo(0,0); showToast('Datos de la aplicación borrados.', 'success');
        }
      });
      $('logout')?.addEventListener('click', ()=>{ show('loginView'); $('loginPass').value=''; toggleResetVisibility(); });
	  $('logoutTop')?.addEventListener('click', () => $('logout')?.click());
	  $('contactSelect')?.addEventListener('change', (e)=> {
          updateSelectedContactCard(e.target.value || '');
          const msgArea = $('msg');
          const tplId = $('templateSelectSend').value;
          if (msgArea && !tplId) {
              msgArea.value = buildMessage();
          }
      });

      (function setupPhoneInput(){
        const el = $('newPhone'); el.type='tel'; el.inputMode='tel';
        el.addEventListener('focus', ()=>{ if(!el.value) el.value='+34'; });
        el.addEventListener('input', ()=>{ el.value = '+'+el.value.replace(/[^\d]/g,''); });
      })();

      $('btnAdd')?.addEventListener('click', async ()=>{
	    const name=$('newName').value.trim(), phone=normalizePhoneNumber($('newPhone').value.trim());
		$('newPhone').value = phone;
	    if(!name){ showToast('Introduce un nombre', 'error'); return; }
	    if(!isPhoneValid(phone)){ showToast('Teléfono inválido. Usa formato: +34600111222', 'error'); return; }
	    const st=S.state(); if(!st||!S.getKey()) return;
	    const vault = await decryptJson(S.getKey(), st.vault);
	    const list = vault.list || [];
	    if (editingPhone){
		  const idx = list.findIndex(x => x.phone === editingPhone); if (idx < 0) return;
		  if (list.some((x,i)=> i!==idx && x.phone === phone)){ showToast('Ese teléfono ya existe.', 'error'); return; }
		  list[idx] = { name, phone }; vault.list = sortContacts(list);
		  st.vault=await encryptJson(S.getKey(), vault); S.save(st);
		  await propagateContactEdit(editingPhone, phone, name);
		  refreshContactsSelect(vault.list); if(getAutoBackup()) exportFixedBackup(true);
		  editingPhone = null; $('newName').value = ''; $('newPhone').value = '+34';
		  $('btnAdd').textContent = 'Añadir contacto'; $('btnCancelEdit')?.remove();
		  showToast('Contacto actualizado.', 'success');
	    } else {
		  if(list.some(c=>c.phone===phone)){ showToast('Ese teléfono ya existe', 'error'); return; }
		  list.push({name, phone}); vault.list = sortContacts(list);
		  st.vault=await encryptJson(S.getKey(), vault); S.save(st);
		  refreshContactsSelect(vault.list); if(getAutoBackup()) exportFixedBackup(true);
		  $('newName').value = ''; $('newPhone').value = '+34'; $('newName').focus();
		  showToast('Contacto añadido.', 'success');
	    }
		triggerAutoBackup();
	  });

      $('dt')?.addEventListener('change', ()=>{ $('msg').value=buildMessage(); });
      $('btnSend')?.addEventListener('click', ()=>{
        const phone = $('contactSelect')?.value;
        const msg = ($('msg')?.value||buildMessage()).trim();
        const contact = findContactByPhone(phone);

        if(!isPhoneValid(phone)){ showToast('Selecciona un contacto válido', 'error'); return; }

        const finalMsg = applyTemplate(msg, contact?.name);

        const tempEvent = {
            title: 'Recordatorio de Cita',
            start: $('dt')?.value,
            note: finalMsg
        };

        const calendarLink = generateCalendarLink(tempEvent);
        let messageToSend = finalMsg;

        if (calendarLink) {
            messageToSend += `\n\n🗓️ Para añadir esta cita a tu calendario, haz clic en el siguiente enlace:\n${calendarLink}`;
        }

        openExternal(`https://wa.me/${phone.replace('+','')}/?text=${encodeURIComponent(messageToSend)}`);
      });
	  $('gCalAutoToggle')?.addEventListener('change', (e)=> setGCalAuto(e.target.checked));
	  $('btnGConnect')?.addEventListener('click', ()=>{ if (googleTokenClient) googleTokenClient.requestAccessToken({ prompt: 'consent' }); });

	  const setupImportButton = (btnId, importFn) => {
		$(btnId)?.addEventListener('click', () => {
			const i = document.createElement('input'); i.type = 'file'; i.accept = 'application/json,.json'; i.style.display = 'none';
			document.body.appendChild(i);
			i.addEventListener('change', async () => { if (i.files[0]) await importFn(i.files[0]); i.remove(); });
			i.click();
		});
	  };
	  setupImportButton('btnImportFull', importFullFixedFromFile);
	  setupImportButton('btnImportAgenda', importAgendaFixedFromFile);
	  setupImportButton('btnImportApp', importFixedBackupFromFile);

	  $('btnExportFull')?.addEventListener('click', exportFullFixed);
	  $('btnExportAgenda')?.addEventListener('click', ()=>exportAgendaFixed(false));
	  $('btnExportFixed')?.addEventListener('click', ()=>exportFixedBackup(false));
      $('btnExportCsv')?.addEventListener('click', exportCSV);
	  $('autoBackupCalToggle')?.addEventListener('change', (e)=>setAutoBackupCal(e.target.checked));
	  $('btnDownloadAutoCal')?.addEventListener('click', ()=>{ if(pendingAutoCalBackup){ saveFileSmart(pendingAutoCalBackup.name, 'application/json', pendingAutoCalBackup.json); pendingAutoCalBackup=null; showAutoCalToast(false); } });
      $('autoBackupToggle')?.addEventListener('change', (e)=>setAutoBackup(e.target.checked));
      $('btnDownloadAuto')?.addEventListener('click', ()=>{ if(pendingAutoBackup){ saveFileSmart(pendingAutoBackup.name, 'application/json', pendingAutoBackup.json); pendingAutoBackup=null; showAutoToast(false); } });

	  $('btnFsaSetup')?.addEventListener('click', async () => {
		try {
			const dirHandle = await window.showDirectoryPicker();
			if (await dirHandle.requestPermission({ mode: 'readwrite' }) !== 'granted') {
				showToast('Permiso para escribir en la carpeta denegado.', 'error');
				await idbKeyval.del('backupDirHandle');
				await updateFsaStatus();
				return;
			}
			await idbKeyval.set('backupDirHandle', dirHandle);
			await updateFsaStatus();
			showToast('Guardado automático activado.', 'success');
			triggerAutoFsaBackup();
		} catch (error) {
			if (error.name !== 'AbortError') {
				console.error('Error al configurar FSA:', error);
				showToast('No se pudo configurar la carpeta.', 'error');
			}
		}
	  });
	  
	  $('btnAutoBackupSetup')?.addEventListener('click', async () => {
		if (fsaSupported) {
			try {
				const dirHandle = await window.showDirectoryPicker();
				if (await dirHandle.requestPermission({ mode: 'readwrite' }) !== 'granted') {
					showToast('Permiso para escribir en la carpeta denegado.', 'error');
					await idbKeyval.del('backupDirHandle');
				} else {
					await idbKeyval.set('backupDirHandle', dirHandle);
					showToast('Guardado en dispositivo activado.', 'success');
					triggerAutoBackup();
				}
			} catch (error) {
				if (error.name !== 'AbortError') { console.error('Error al configurar FSA:', error); showToast('No se pudo configurar la carpeta.', 'error'); }
			}
		} else {
			const idbEnabled = await idbKeyval.get('idbBackupEnabled');
			if (idbEnabled) {
				await idbKeyval.del('idbBackupEnabled');
				await idbKeyval.del('idbBackupContent');
				showToast('Guardado interno desactivado.', 'info');
			} else {
				await idbKeyval.set('idbBackupEnabled', true);
				showToast('Guardado interno activado.', 'success');
				triggerAutoBackup();
			}
		}
		await updateAutoBackupStatus();
	  });
	  
      wireSearch(); wireModalSearch();
      $('btnNewEvent')?.addEventListener('click', ()=>openEventModal());
      $('evtSave')?.addEventListener('click', saveEvent);
      $('evtDelete')?.addEventListener('click', ()=>{ const id=$('evtId').value; if(id) deleteEvent(id); });
      $('evtSend')?.addEventListener('click', ()=>{
        const phone = $('evtContact').value;
        if (!phone) {
            showToast('Debes seleccionar un contacto para enviar la cita.', 'error', 3000, 'modal');
            return;
        }
        const contact = findContactByPhone(phone);
        if (!contact || !isPhoneValid(contact.phone)) {
            showToast('El contacto seleccionado no es válido.', 'error', 3000, 'modal');
            return;
        }

        const tmpEvt = {
            title: $('evtTitle').value.trim() || 'Cita',
            start: new Date($('evtStart').value).toISOString(),
            end: $('evtEnd').value ? new Date($('evtEnd').value).toISOString() : null,
            note: $('evtNote').value.trim(),
            contactPhone: contact?.phone, 
            contactName: contact?.name
        };

        const messageToSend = buildEventMessage(tmpEvt);
        
        openExternal(`https://wa.me/${contact.phone.replace('+','')}/?text=${encodeURIComponent(messageToSend)}`);
      });
      $('evtClose')?.addEventListener('click', closeEventModal);
      ['loginUser','loginPass','setupUser','setupPass'].forEach(id=>{ $(id)?.addEventListener('keydown',e=>{ if(e.key==='Enter') (id.startsWith('login')?$('btnLogin'):$('btnSetup'))?.click(); }); });
	  
	  $('btnSaveTemplate')?.addEventListener('click', saveTemplate);
	  $('btnCancelEditTemplate')?.addEventListener('click', resetTemplateForm);
	  $('templateSelectSend')?.addEventListener('change', async (e) => {
			const tplId = e.target.value;
			const msgArea = $('msg');
			if (!tplId) { msgArea.value = buildMessage(); return; }
			const st = S.state(); if (!st || !S.getKey()) return;
			const vault = await decryptJson(S.getKey(), st.vault);
			const template = (vault.templates || []).find(t => t.id === tplId);
			const contact = findContactByPhone($('contactSelect')?.value);
			if (template) { msgArea.value = applyTemplate(template.content, contact?.name); }
	  });
	  $('templateSelectModal')?.addEventListener('change', async (e) => {
			const tplId = e.target.value;
			if (!tplId) return;
			const st = S.state(); if (!st || !S.getKey()) return;
			const vault = await decryptJson(S.getKey(), st.vault);
			const template = (vault.templates || []).find(t => t.id === tplId);
			if (template) {
                const contact = findContactByPhone($('evtContact').value);
                const currentNotes = $('evtNote').value;
                const newContent = applyTemplate(template.content, contact?.name);
                $('evtNote').value = currentNotes ? `${currentNotes}\n\n${newContent}` : newContent;
            }
	  });
		
	  $('viewMonth')?.addEventListener('click', () => {
			currentView = 'month';
			$('viewMonth').classList.add('is-active');
			$('viewWeek').classList.remove('is-active');
			$('calGrid').style.display = 'grid';
			$('calGridWeekly').style.display = 'none';
            $('dayToolbar').style.display = 'flex';
			$('dayList').style.display = 'grid';
			renderCalendar();
	  });
	  $('viewWeek')?.addEventListener('click', () => {
			currentView = 'week';
			$('viewWeek').classList.add('is-active');
			$('viewMonth').classList.remove('is-active');
			$('calGrid').style.display = 'none';
			$('calGridWeekly').style.display = 'grid';
            $('dayToolbar').style.display = 'none';
			$('dayList').style.display = 'none';
			currentWeekDate = selectedDay;
			renderWeeklyCalendar();
	  });

	  $('calPrev').onclick = () => {
			if (currentView === 'month') {
				currentMonth.setMonth(currentMonth.getMonth() - 1);
                selectedDay.setMonth(selectedDay.getMonth() - 1);
				renderCalendar();
			} else {
				currentWeekDate = addDays(currentWeekDate, -7);
				renderWeeklyCalendar();
			}
	  };
	  $('calNext').onclick = () => {
			if (currentView === 'month') {
				currentMonth.setMonth(currentMonth.getMonth() + 1);
                selectedDay.setMonth(selectedDay.getMonth() + 1);
				renderCalendar();
			} else {
				currentWeekDate = addDays(currentWeekDate, 7);
				renderWeeklyCalendar();
			}
	  };
	  $('calToday').onclick = () => {
			selectedDay = new Date();
			if (currentView === 'month') {
				currentMonth = new Date();
				renderCalendar();
			} else {
				currentWeekDate = new Date();
				renderWeeklyCalendar();
			}
	  };
    }

	// ===== MOBILE TABS & PWA =====
	if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
	function setActiveTab(tab){
	  const allowed = new Set(['agenda','send','contacts','backups', 'templates']);
	  const t = allowed.has(tab) ? tab : 'agenda';
	  document.body.setAttribute('data-tab', t);
	  document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn=> btn.classList.toggle('is-active', btn.dataset.tab === t));
	}
	function wireBottomNav(){
	  $('bottomNav')?.addEventListener('click', (e)=>{ const btn = e.target.closest('.nav-btn'); if(btn) setActiveTab(btn.dataset.tab); });
	}
	(function flagStandalone(){
	  const apply = () => document.documentElement.classList.toggle('standalone', !!(window.matchMedia?.('(display-mode: standalone)').matches || navigator.standalone));
	  apply(); window.matchMedia?.('(display-mode: standalone)').addEventListener('change', apply);
	})();

    // ===== INITIALIZATION =====
	async function init(){
		const startupLogic = async () => {
			try {
				if (S.state()) {
					show('loginView');
					return;
				}
				let backupContent = null;
				if (fsaSupported) {
					const dirHandle = await idbKeyval.get('backupDirHandle');
					if (dirHandle) {
						try {
							const fileHandle = await dirHandle.getFileHandle(FsaBackupFile); // <-- CORREGIDO
							const file = await fileHandle.getFile();
							backupContent = await file.text();
						} catch (e) {
							console.log("No se encontró el archivo de respaldo en la carpeta.");
						}
					}
				} else {
					backupContent = await idbKeyval.get('idbBackupContent');
				}
				if (backupContent) {
					const restore = await showConfirmation('Restaurar Copia de Seguridad', 'Parece que no hay datos locales, pero se encontró una copia de seguridad. ¿Quieres restaurarla?');
					if (restore) {
						const success = await importFullFixedFromContent(backupContent);
						if (success) {
							show('loginView');
						} else {
							show('setupView');
						}
						return;
					}
				}
				show('setupView');
			} catch (error) {
				console.error('Error crítico en el arranque, mostrando vista de configuración por defecto.', error);
				show('setupView');
			}
		};
		await startupLogic();

		const m=$('msg'); if(m) m.value=buildMessage();
		const d=new Date(Date.now()+60*60*1000);
		$('dt').value=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
		wireEvents(); // <-- Se llama a la versión corregida de wireEvents
		wireBottomNav();
		setActiveTab('agenda');
		(function waitGIS(){ if (window.google?.accounts?.oauth2) setupGoogle(); else setTimeout(waitGIS, 300); })();
		
		const backupContainer = $('autoBackupContainer');
        if(backupContainer) backupContainer.style.display = 'block';

		if ('contacts' in navigator && 'select' in navigator.contacts) {
		  document.body.classList.add('contact-picker-supported');
		  $('btnImportContactSend')?.addEventListener('click', () => importAndSelectContact(selectContact, 'global'));
		  $('btnImportContactModal')?.addEventListener('click', () => importAndSelectContact(selectModalContact, 'modal'));
		  const btn = $('btnImportDevice'); 
		  if(btn) btn.style.display = 'inline-flex';
		  btn.onclick = async () => {
			  try {
				  const contacts = await navigator.contacts.select(['name', 'tel'], {multiple: true});
				  if (!contacts.length) return;
				  const st = S.state(); if (!st || !S.getKey()) return;
				  const vault = await decryptJson(S.getKey(), st.vault);
				  let added = 0, skipped = 0;
				  const phoneSet = new Set((vault.list || []).map(c => c.phone));
				  contacts.forEach(contact => {
					  if (contact.tel && contact.tel.length > 0) {
						  const phone = normalizePhoneNumber(contact.tel[0]);
						  if (!phoneSet.has(phone)) {
							  vault.list.push({name: contact.name[0] || 'Sin Nombre', phone});
							  phoneSet.add(phone);
							  added++;
						  } else { skipped++; }
					  }
				  });
				  if (added > 0) {
					  st.vault = await encryptJson(S.getKey(), vault);
					  S.save(st);
					  refreshContactsSelect(vault.list);
					  triggerAutoBackup(); 
				  }
				  showToast(`${added} contactos importados. ${skipped} ya existían.`, 'success');
			  } catch (err) {
				  console.error(err);
				  showToast('No se pudieron importar los contactos.', 'error');
			  }
		  };
		}
	}
	
	// ===== WEBAUTHN BIOMETRIC LOGIN =====
	const webAuthn = (() => {
		const CREDENTIAL_ID_KEY = 'mf-gestor-citas-webauthn-credential-id';

		const isSupported = () => window.PublicKeyCredential &&
			PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable &&
			PublicKeyCredential.isConditionalMediationAvailable;

		const arrayToBase64 = (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer)));
		const base64ToArray = (base64) => Uint8Array.from(atob(base64), c => c.charCodeAt(0));

		const register = async (username, password) => {
			if (!isSupported()) return showToast('Tu navegador no soporta claves de acceso.', 'error');
			
			const challenge = crypto.getRandomValues(new Uint8Array(32));
			const userId = base64ToArray(btoa(username));

			try {
				// Paso 1: Primero, guardamos la contraseña en el gestor del navegador.
				// Esto es crucial para que iOS la asocie con la clave de acceso (Passkey).
				const passwordCredential = new PasswordCredential({ id: username, password: password });
				await navigator.credentials.store(passwordCredential);
				
				// Paso 2: Ahora, creamos la clave de acceso biométrica.
				const credential = await navigator.credentials.create({
					publicKey: {
						challenge,
						rp: { name: "MF Gestor de Citas", id: window.location.hostname },
						user: { id: userId, name: username, displayName: username },
						pubKeyCredParams: [{ type: "public-key", alg: -7 }, { type: "public-key", alg: -257 }],
						authenticatorSelection: {
							authenticatorAttachment: "platform",
							userVerification: "required",
							residentKey: "required",
						}
					}
				});

				if (credential) {
					localStorage.setItem(CREDENTIAL_ID_KEY, arrayToBase64(credential.rawId));
					showToast('¡Acceso biométrico activado!', 'success');
					updateUi();
				}
			} catch (err) {
				console.error("Error en registro de Passkey:", err);
				showToast('No se pudo activar la biometría.', 'error');
			}
		};

		const initConditionalLogin = async () => {
			if (!isSupported()) return;
			
			try {
				// El navegador mostrará la opción de autocompletar con Passkey
				const passkeyCredential = await navigator.credentials.get({
					mediation: 'conditional',
					publicKey: {
						challenge: crypto.getRandomValues(new Uint8Array(32)),
						userVerification: 'required'
					}
				});

				if (passkeyCredential) {
					// Si el usuario elige la Passkey, el navegador nos dará la contraseña asociada
					const passwordCredential = await navigator.credentials.get({ password: true });

					if (passwordCredential) {
						$('loginUser').value = passwordCredential.id;
						$('loginPass').value = passwordCredential.password;
						// Forzamos el click para que el flujo de login original se ejecute
						setTimeout(() => $('btnLogin').click(), 100);
					} else {
					   showToast('No se encontró una contraseña asociada a la clave de acceso.', 'error');
					}
				}
			} catch (err) {
				console.log("Login condicional no disponible o cancelado:", err.name);
			}
		};

		const disable = async () => {
			localStorage.removeItem(CREDENTIAL_ID_KEY);
			// Opcional: Esto ayuda a limpiar la asociación en algunos navegadores.
			if (navigator.credentials && navigator.credentials.preventSilentAccess) {
				await navigator.credentials.preventSilentAccess();
			}
			showToast('Acceso biométrico desactivado.', 'info');
			updateUi();
		};

		const updateUi = () => {
			const section = $('biometricSection'), status = $('biometricStatus');
			if (!section || !status) return; // Si el HTML no existe, salimos.

			if (!isSupported()) {
				section.style.display = 'block';
				status.innerHTML = `
					<p class="muted" style="font-size: 12px; color: var(--warning);">
						El acceso biométrico no está disponible.<br>
						Motivo: Tu navegador no es compatible o la página no se está sirviendo por HTTPS.
					</p>
				`;
				return;
			}

			section.style.display = 'block';
			const storedCredId = localStorage.getItem(CREDENTIAL_ID_KEY);

			if (storedCredId) {
				status.innerHTML = `
					<p class="muted" style="color: var(--ok);">✅ El acceso biométrico está activado.</p>
					<button id="btnDisableBiometric" class="btn-small btn-danger" type="button">Desactivar</button>
				`;
				$('btnDisableBiometric').onclick = disable;
			} else {
				status.innerHTML = `
					<button id="btnEnableBiometric" class="btn btn-outline" type="button">Activar acceso biométrico</button>
				`;
				$('btnEnableBiometric').onclick = async () => {
					const pass = prompt("Para activar el acceso biométrico, por favor, confirma tu contraseña actual:");
					if (!pass) return;

					const state = S.state();
					try {
						const r = await derive(pass, state.saltB64);
						if (r.pwHashB64 === state.pwHashB64) {
							await register(S.getUser(), pass);
						} else {
							showToast('Contraseña incorrecta.', 'error');
						}
					} catch (e) {
						showToast('Error al verificar la contraseña.', 'error');
					}
				};
			}
		};

		return { initConditionalLogin, updateUi };
	})();
	
	
    document.addEventListener('DOMContentLoaded', init);
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js?v=ui25').catch(()=>{})); }
</script>